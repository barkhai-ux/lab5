<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live HTML & CSS Editor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #1e1e2e;
    color: #cdd6f4;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  header {
    background: #181825;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #313244;
  }

  header h1 {
    font-size: 16px;
    font-weight: 600;
    color: #cba6f7;
  }

  header .actions {
    display: flex;
    gap: 8px;
  }

  header button {
    background: #313244;
    color: #cdd6f4;
    border: 1px solid #45475a;
    padding: 5px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: background 0.2s;
  }

  header button:hover {
    background: #45475a;
  }

  .main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  .editors {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  .editor-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
    border-bottom: 1px solid #313244;
  }

  .editor-panel:last-child {
    border-bottom: none;
  }

  .panel-header {
    background: #181825;
    padding: 6px 14px;
    font-size: 12px;
    font-weight: 600;
    color: #a6adc8;
    display: flex;
    align-items: center;
    gap: 8px;
    border-bottom: 1px solid #313244;
  }

  .panel-header .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .panel-header .dot.html { background: #fab387; }
  .panel-header .dot.css { background: #89b4fa; }

  .editor-wrap {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: #1e1e2e;
  }

  .editor-wrap textarea,
  .editor-wrap pre {
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.6;
    padding: 12px 12px 12px 52px;
    white-space: pre;
    overflow: auto;
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    tab-size: 2;
    -moz-tab-size: 2;
  }

  .editor-wrap textarea {
    background: transparent;
    color: transparent;
    caret-color: #f5e0dc;
    border: none;
    outline: none;
    resize: none;
    z-index: 2;
  }

  .editor-wrap pre {
    z-index: 1;
    margin: 0;
    pointer-events: none;
    color: #cdd6f4;
  }

  .editor-wrap pre code {
    font-family: inherit;
    font-size: inherit;
    line-height: inherit;
  }

  .line-numbers {
    position: absolute;
    top: 0;
    left: 0;
    width: 40px;
    height: 100%;
    background: #181825;
    z-index: 3;
    padding: 12px 8px 12px 0;
    text-align: right;
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.6;
    color: #585b70;
    overflow: hidden;
    pointer-events: none;
    border-right: 1px solid #313244;
    user-select: none;
  }

  .preview-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    border-left: 2px solid #313244;
    min-width: 0;
  }

  .preview-panel .panel-header .dot { background: #a6e3a1; }

  .preview-panel iframe {
    flex: 1;
    border: none;
    background: #fff;
  }

  .resizer {
    width: 5px;
    cursor: col-resize;
    background: #313244;
    transition: background 0.2s;
    flex-shrink: 0;
  }

  .resizer:hover, .resizer.active {
    background: #cba6f7;
  }

  /* Sidebar */
  .sidebar {
    width: 260px;
    min-width: 260px;
    background: #181825;
    border-right: 1px solid #313244;
    display: flex;
    flex-direction: column;
    transition: margin-left 0.25s ease, opacity 0.25s ease;
    z-index: 10;
    overflow: hidden;
  }

  .sidebar.collapsed {
    margin-left: -260px;
    opacity: 0;
    pointer-events: none;
  }

  .sidebar-header {
    padding: 12px 14px 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #313244;
  }

  .sidebar-header h2 {
    font-size: 13px;
    font-weight: 700;
    color: #a6adc8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .sidebar-header button {
    background: #cba6f7;
    color: #1e1e2e;
    border: none;
    padding: 4px 12px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 700;
    transition: background 0.2s;
  }

  .sidebar-header button:hover { background: #b491e0; }

  .sidebar-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }

  .sidebar-list::-webkit-scrollbar { width: 4px; }
  .sidebar-list::-webkit-scrollbar-thumb { background: #45475a; border-radius: 4px; }

  .sidebar-empty {
    text-align: center;
    color: #585b70;
    font-size: 12px;
    padding: 32px 16px;
    line-height: 1.6;
  }

  .project-card {
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 4px;
    border: 1px solid transparent;
    transition: background 0.15s, border-color 0.15s;
    position: relative;
  }

  .project-card:hover {
    background: #1e1e2e;
    border-color: #313244;
  }

  .project-card.active {
    background: #1e1e2e;
    border-color: #cba6f7;
  }

  .project-card .pc-name {
    font-size: 13px;
    font-weight: 600;
    color: #cdd6f4;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding-right: 40px;
  }

  .project-card.active .pc-name { color: #cba6f7; }

  .project-card .pc-date {
    font-size: 10px;
    color: #585b70;
    margin-top: 2px;
  }

  .project-card .pc-actions {
    position: absolute;
    top: 8px;
    right: 8px;
    display: flex;
    gap: 2px;
    opacity: 0;
    transition: opacity 0.15s;
  }

  .project-card:hover .pc-actions { opacity: 1; }
  .project-card.active .pc-actions { opacity: 1; }

  .pc-actions button {
    background: none;
    border: none;
    color: #6c7086;
    cursor: pointer;
    padding: 2px 5px;
    border-radius: 4px;
    font-size: 13px;
    line-height: 1;
    transition: color 0.15s, background 0.15s;
  }

  .pc-actions button:hover { color: #cdd6f4; background: #313244; }
  .pc-actions button.pc-del:hover { color: #f38ba8; background: #313244; }

  .sidebar-toggle {
    background: none;
    border: none;
    color: #a6adc8;
    cursor: pointer;
    font-size: 18px;
    padding: 2px 8px;
    border-radius: 4px;
    transition: color 0.2s, background 0.2s;
    line-height: 1;
  }

  .sidebar-toggle:hover { color: #cba6f7; background: #313244; }

  .header-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .unsaved-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #fab387;
    display: none;
    flex-shrink: 0;
    margin-left: -4px;
  }

  .unsaved-dot.show { display: inline-block; }

  /* Toast notification */
  .toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    padding: 10px 24px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s, transform 0.3s;
  }

  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  .toast.success { background: #a6e3a1; color: #1e1e2e; }
  .toast.error { background: #f38ba8; color: #1e1e2e; }
  .toast.info { background: #89b4fa; color: #1e1e2e; }

  /* Confirm dialog */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 900;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.show { display: flex; }

  .modal {
    background: #1e1e2e;
    border: 1px solid #45475a;
    border-radius: 12px;
    padding: 24px;
    min-width: 320px;
    max-width: 420px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  }

  .modal h3 {
    font-size: 15px;
    margin-bottom: 12px;
    color: #cdd6f4;
  }

  .modal input {
    width: 100%;
    padding: 8px 12px;
    background: #313244;
    border: 1px solid #45475a;
    border-radius: 6px;
    color: #cdd6f4;
    font-size: 13px;
    outline: none;
    margin-bottom: 16px;
  }

  .modal input:focus { border-color: #cba6f7; }

  .modal .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }

  .modal button {
    background: #313244;
    color: #cdd6f4;
    border: 1px solid #45475a;
    padding: 6px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
  }

  .modal button:hover { background: #45475a; }

  .modal button.primary {
    background: #cba6f7;
    color: #1e1e2e;
    border-color: #cba6f7;
  }

  .modal button.primary:hover { background: #b491e0; }

  .modal button.danger {
    background: #f38ba8;
    color: #1e1e2e;
    border-color: #f38ba8;
  }

  .modal button.danger:hover { background: #e07090; }

  /* Syntax highlighting colors */
  .hl-tag { color: #f38ba8; }
  .hl-attr { color: #fab387; }
  .hl-str { color: #a6e3a1; }
  .hl-comment { color: #585b70; font-style: italic; }
  .hl-entity { color: #f5c2e7; }
  .hl-bracket { color: #6c7086; }
  .hl-text { color: #cdd6f4; }
  .hl-css-sel { color: #f38ba8; }
  .hl-css-prop { color: #89b4fa; }
  .hl-css-val { color: #a6e3a1; }
  .hl-css-unit { color: #fab387; }
  .hl-css-punct { color: #6c7086; }
  .hl-css-comment { color: #585b70; font-style: italic; }
  .hl-css-atrule { color: #cba6f7; }
  .hl-css-important { color: #f38ba8; font-weight: bold; }
</style>
</head>
<body>

<header>
  <div class="header-left">
    <button class="sidebar-toggle" id="sidebarToggle" title="Toggle projects">&#9776;</button>
    <h1>&#9998; Live HTML &amp; CSS Editor</h1>
    <span class="unsaved-dot" id="unsavedDot" title="Unsaved changes"></span>
  </div>
  <div class="actions">
    <button onclick="saveProject()">Save</button>
    <button onclick="resetEditors()">Reset</button>
    <button onclick="copyOutput()">Copy Output</button>
    <button onclick="downloadZip()">Download ZIP</button>
  </div>
</header>

<div id="toast" class="toast"></div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modal">
    <h3 id="modalTitle"></h3>
    <input type="text" id="modalInput" autocomplete="off">
    <div class="modal-actions">
      <button onclick="closeModal()">Cancel</button>
      <button class="primary" id="modalConfirm">OK</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="confirmOverlay">
  <div class="modal" id="confirmModal">
    <h3 id="confirmTitle"></h3>
    <div class="modal-actions">
      <button onclick="closeConfirm()">Cancel</button>
      <button class="danger" id="confirmBtn">Delete</button>
    </div>
  </div>
</div>

<div class="main">
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>Projects</h2>
      <button onclick="newProject()">+ New</button>
    </div>
    <div class="sidebar-list" id="sidebarList"></div>
  </div>

  <div class="editors" id="editorsPane">
    <!-- HTML Editor -->
    <div class="editor-panel">
      <div class="panel-header"><span class="dot html"></span>HTML</div>
      <div class="editor-wrap">
        <div class="line-numbers" id="htmlLines">1</div>
        <pre><code id="htmlHighlight"></code></pre>
        <textarea id="htmlEditor" spellcheck="false"></textarea>
      </div>
    </div>
    <!-- CSS Editor -->
    <div class="editor-panel">
      <div class="panel-header"><span class="dot css"></span>CSS</div>
      <div class="editor-wrap">
        <div class="line-numbers" id="cssLines">1</div>
        <pre><code id="cssHighlight"></code></pre>
        <textarea id="cssEditor" spellcheck="false"></textarea>
      </div>
    </div>
  </div>

  <div class="resizer" id="resizer"></div>

  <div class="preview-panel" id="previewPane">
    <div class="panel-header"><span class="dot"></span>Preview</div>
    <iframe id="preview"></iframe>
  </div>
</div>

<script>
const htmlEditor = document.getElementById('htmlEditor');
const cssEditor = document.getElementById('cssEditor');
const htmlHighlight = document.getElementById('htmlHighlight');
const cssHighlight = document.getElementById('cssHighlight');
const htmlLines = document.getElementById('htmlLines');
const cssLines = document.getElementById('cssLines');
const preview = document.getElementById('preview');

const defaultHTML = '<div class="card">\n  <h1>Hello World!<\/h1>\n  <p>Start editing to see changes live.<\/p>\n  <button class="btn">Click Me<\/button>\n<\/div>';

const defaultCSS = 'body {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  min-height: 100vh;\n  margin: 0;\n  background: #f0f0f0;\n  font-family: sans-serif;\n}\n\n.card {\n  background: white;\n  padding: 40px;\n  border-radius: 12px;\n  box-shadow: 0 4px 24px rgba(0,0,0,0.1);\n  text-align: center;\n}\n\nh1 {\n  color: #333;\n  margin-bottom: 10px;\n}\n\np {\n  color: #666;\n  margin-bottom: 20px;\n}\n\n.btn {\n  background: #6c5ce7;\n  color: white;\n  border: none;\n  padding: 10px 28px;\n  border-radius: 6px;\n  font-size: 16px;\n  cursor: pointer;\n  transition: background 0.2s;\n}\n\n.btn:hover {\n  background: #5a4bd1;\n}';

function escapeHTML(str) {
  return str.replace(/&/g, '&amp;').replace(/\x3c/g, '&lt;').replace(/>/g, '&gt;');
}

// ---- HTML Syntax Highlighting ----
function highlightHTML(code) {
  let result = '';
  let i = 0;
  while (i < code.length) {
    // Comments
    if (code.startsWith('<!--', i)) {
      let end = code.indexOf('-->', i);
      if (end === -1) end = code.length - 3;
      result += '<span class="hl-comment">' + escapeHTML(code.slice(i, end + 3)) + '</span>';
      i = end + 3;
    }
    // Tags
    else if (code[i] === '<' && (code[i+1] === '/' || /[a-zA-Z!]/.test(code[i+1] || ''))) {
      let tag = '<span class="hl-bracket">&lt;</span>';
      i++;
      if (code[i] === '/') { tag += '<span class="hl-bracket">/</span>'; i++; }
      // Tag name
      let name = '';
      while (i < code.length && /[a-zA-Z0-9\-]/.test(code[i])) { name += code[i]; i++; }
      tag += '<span class="hl-tag">' + escapeHTML(name) + '</span>';
      // Attributes
      while (i < code.length && code[i] !== '>' && !(code[i] === '/' && code[i+1] === '>')) {
        if (/\s/.test(code[i])) { tag += code[i]; i++; continue; }
        // Attribute name
        let attr = '';
        while (i < code.length && /[a-zA-Z0-9\-_]/.test(code[i])) { attr += code[i]; i++; }
        if (attr) tag += '<span class="hl-attr">' + escapeHTML(attr) + '</span>';
        // =
        if (code[i] === '=') {
          tag += '<span class="hl-bracket">=</span>'; i++;
          // Attribute value
          if (code[i] === '"' || code[i] === "'") {
            let q = code[i]; let val = q; i++;
            while (i < code.length && code[i] !== q) { val += code[i]; i++; }
            if (i < code.length) { val += code[i]; i++; }
            tag += '<span class="hl-str">' + escapeHTML(val) + '</span>';
          }
        }
        if (!/[\s\/>a-zA-Z0-9\-_=]/.test(code[i] || '>')) { tag += escapeHTML(code[i] || ''); i++; }
      }
      if (code[i] === '/' && code[i+1] === '>') {
        tag += '<span class="hl-bracket">/&gt;</span>'; i += 2;
      } else if (code[i] === '>') {
        tag += '<span class="hl-bracket">&gt;</span>'; i++;
      }
      result += tag;
    }
    // Entity
    else if (code[i] === '&') {
      let ent = '&';
      i++;
      while (i < code.length && /[a-zA-Z0-9#]/.test(code[i])) { ent += code[i]; i++; }
      if (code[i] === ';') { ent += ';'; i++; }
      result += '<span class="hl-entity">' + escapeHTML(ent) + '</span>';
    }
    else {
      result += escapeHTML(code[i]);
      i++;
    }
  }
  return result;
}

// ---- CSS Syntax Highlighting ----
function highlightCSS(code) {
  let result = '';
  let i = 0;
  while (i < code.length) {
    // Comments
    if (code[i] === '/' && code[i+1] === '*') {
      let end = code.indexOf('*/', i + 2);
      if (end === -1) end = code.length - 2;
      result += '<span class="hl-css-comment">' + escapeHTML(code.slice(i, end + 2)) + '</span>';
      i = end + 2;
    }
    // @ rules
    else if (code[i] === '@') {
      let word = '@';
      i++;
      while (i < code.length && /[a-zA-Z\-]/.test(code[i])) { word += code[i]; i++; }
      result += '<span class="hl-css-atrule">' + escapeHTML(word) + '</span>';
    }
    // Inside a block
    else if (code[i] === '{') {
      result += '<span class="hl-css-punct">{</span>';
      i++;
      // Properties inside block
      while (i < code.length && code[i] !== '}') {
        // Comments inside block
        if (code[i] === '/' && code[i+1] === '*') {
          let end = code.indexOf('*/', i + 2);
          if (end === -1) end = code.length - 2;
          result += '<span class="hl-css-comment">' + escapeHTML(code.slice(i, end + 2)) + '</span>';
          i = end + 2;
        }
        // Nested block (media queries etc.)
        else if (code[i] === '{') {
          result += '<span class="hl-css-punct">{</span>';
          i++;
        }
        // Whitespace
        else if (/\s/.test(code[i])) {
          result += code[i]; i++;
        }
        // Property
        else {
          let prop = '';
          while (i < code.length && code[i] !== ':' && code[i] !== '}' && code[i] !== '{' && !(code[i] === '/' && code[i+1] === '*')) {
            prop += code[i]; i++;
          }
          if (code[i] === ':') {
            result += '<span class="hl-css-prop">' + escapeHTML(prop) + '</span>';
            result += '<span class="hl-css-punct">:</span>';
            i++;
            // Value
            let val = '';
            while (i < code.length && code[i] !== ';' && code[i] !== '}') {
              val += code[i]; i++;
            }
            // Highlight value with units and !important
            let hv = escapeHTML(val);
            hv = hv.replace(/(\d+\.?\d*)(px|em|rem|%|vh|vw|vmin|vmax|s|ms|deg|fr|ch|ex)/g,
              '$1<span class="hl-css-unit">$2</span>');
            hv = hv.replace(/(!important)/g, '<span class="hl-css-important">$1</span>');
            result += '<span class="hl-css-val">' + hv + '</span>';
            if (code[i] === ';') {
              result += '<span class="hl-css-punct">;</span>'; i++;
            }
          } else {
            // Likely a selector inside (nested/media)
            result += '<span class="hl-css-sel">' + escapeHTML(prop) + '</span>';
          }
        }
      }
      if (code[i] === '}') {
        result += '<span class="hl-css-punct">}</span>'; i++;
      }
    }
    // Selector (outside blocks)
    else if (/\s/.test(code[i])) {
      result += code[i]; i++;
    }
    else {
      let sel = '';
      while (i < code.length && code[i] !== '{' && !(code[i] === '/' && code[i+1] === '*')) {
        sel += code[i]; i++;
      }
      result += '<span class="hl-css-sel">' + escapeHTML(sel) + '</span>';
    }
  }
  return result;
}

function updateLineNumbers(text, el) {
  const count = text.split('\n').length;
  let nums = '';
  for (let i = 1; i <= count; i++) nums += i + '\n';
  el.textContent = nums;
}

function syncScroll(textarea, pre, lineNums) {
  pre.scrollTop = textarea.scrollTop;
  pre.scrollLeft = textarea.scrollLeft;
  lineNums.style.transform = `translateY(${-textarea.scrollTop}px)`;
}

function updatePreview() {
  const html = htmlEditor.value;
  const css = cssEditor.value;
  const doc = preview.contentDocument || preview.contentWindow.document;
  doc.open();
  doc.write('<!DOCTYPE html><html><head><style>' + css + '<\/style><\/head><body>' + html + '<\/body><\/html>');
  doc.close();
}

function updateHTML() {
  htmlHighlight.innerHTML = highlightHTML(htmlEditor.value) + '\n';
  updateLineNumbers(htmlEditor.value, htmlLines);
  updatePreview();
}

function updateCSS() {
  cssHighlight.innerHTML = highlightCSS(cssEditor.value) + '\n';
  updateLineNumbers(cssEditor.value, cssLines);
  updatePreview();
}

// ---- Void elements (self-closing) ----
var voidElements = new Set(['area','base','br','col','embed','hr','img','input','link','meta','param','source','track','wbr']);

// ---- Emmet Expansion Engine ----
function deepCloneNodes(arr) { return JSON.parse(JSON.stringify(arr)); }

function expandEmmet(abbr) {
  var p = 0;
  function peek() { return p < abbr.length ? abbr[p] : null; }
  function parseIdent() {
    var s = '';
    while (p < abbr.length && /[a-zA-Z0-9]/.test(abbr[p])) s += abbr[p++];
    return s;
  }
  function parseNum() {
    var s = '';
    while (p < abbr.length && /[0-9]/.test(abbr[p])) s += abbr[p++];
    return parseInt(s) || 1;
  }
  function parseText() {
    var s = '', d = 1;
    while (p < abbr.length && d > 0) {
      if (abbr[p] === '{') d++;
      else if (abbr[p] === '}') { d--; if (d === 0) { p++; return s; } }
      s += abbr[p++];
    }
    return s;
  }
  function parseElement() {
    var tag = parseIdent(), id = '', cls = [], txt = '';
    while (p < abbr.length && (abbr[p] === '#' || abbr[p] === '.')) {
      if (abbr[p] === '#') {
        p++; id = '';
        while (p < abbr.length && /[a-zA-Z0-9_-]/.test(abbr[p])) id += abbr[p++];
      } else {
        p++; var c = '';
        while (p < abbr.length && /[a-zA-Z0-9_-]/.test(abbr[p])) c += abbr[p++];
        if (c) cls.push(c);
      }
    }
    if (peek() === '[') {
      p++;
      while (p < abbr.length && abbr[p] !== ']') p++;
      if (peek() === ']') p++;
    }
    if (peek() === '{') { p++; txt = parseText(); }
    if (!tag && !id && cls.length === 0) return null;
    if (!tag) tag = 'div';
    return { tag: tag, id: id, classes: cls, text: txt, children: [] };
  }
  function parseMult() { if (peek() === '*') { p++; return parseNum(); } return 1; }
  function parseFactor() {
    if (peek() === '(') {
      p++;
      var nodes = parseExpr();
      if (peek() === ')') p++;
      var m = parseMult(), res = [];
      for (var i = 0; i < m; i++) res = res.concat(deepCloneNodes(nodes));
      return res;
    }
    var el = parseElement();
    if (!el) return [];
    var m = parseMult();
    if (peek() === '>') { p++; el.children = parseExpr(); }
    var res = [];
    for (var i = 0; i < m; i++) res.push(deepCloneNodes([el])[0]);
    return res;
  }
  function parseExpr() {
    var nodes = parseFactor();
    while (peek() === '+') { p++; nodes = nodes.concat(parseFactor()); }
    return nodes;
  }
  var tree = parseExpr();
  if (tree.length === 0 || p < abbr.length) return null;

  var cursorPlaced = false;
  function renderNode(nd, indent) {
    var sp = '  '.repeat(indent);
    var attrs = '';
    if (nd.id) attrs += ' id="' + nd.id + '"';
    if (nd.classes.length) attrs += ' class="' + nd.classes.join(' ') + '"';
    if (voidElements.has(nd.tag.toLowerCase())) return sp + '\x3c' + nd.tag + attrs + '>';
    var open = '\x3c' + nd.tag + attrs + '>';
    var close = '\x3c/' + nd.tag + '>';
    if (nd.children.length === 0 && !nd.text) {
      if (!cursorPlaced) { cursorPlaced = true; return sp + open + '\0' + close; }
      return sp + open + close;
    }
    if (nd.children.length === 0 && nd.text) return sp + open + nd.text + close;
    var lines = [sp + open];
    if (nd.text) lines.push(sp + '  ' + nd.text);
    for (var j = 0; j < nd.children.length; j++) lines.push(renderNode(nd.children[j], indent + 1));
    lines.push(sp + close);
    return lines.join('\n');
  }
  return tree.map(function(n) { return renderNode(n, 0); }).join('\n');
}

function getEmmetAbbr(text, pos) {
  var start = pos;
  while (start > 0 && /[a-zA-Z0-9#.>+*{}\-_()]/.test(text[start - 1])) start--;
  var abbr = text.substring(start, pos);
  if (!abbr || !/^[a-zA-Z.#(]/.test(abbr)) return null;
  return { start: start, abbr: abbr };
}

// ---- Tab: Emmet expand or indent ----
function handleTab(e) {
  if (e.key !== 'Tab') return;
  e.preventDefault();
  var ta = e.target;
  var pos = ta.selectionStart;

  if (ta === htmlEditor) {
    var em = getEmmetAbbr(ta.value, pos);
    if (em) {
      try {
        var expanded = expandEmmet(em.abbr);
        if (expanded) {
          var lineStart = em.start;
          while (lineStart > 0 && ta.value[lineStart - 1] !== '\n') lineStart--;
          var baseIndent = '';
          var lp = lineStart;
          while (lp < em.start && (ta.value[lp] === ' ' || ta.value[lp] === '\t')) { baseIndent += ta.value[lp]; lp++; }
          var lines = expanded.split('\n');
          var indented = lines[0];
          for (var li = 1; li < lines.length; li++) indented += '\n' + baseIndent + lines[li];
          var cursorIdx = indented.indexOf('\0');
          var clean = indented.replace('\0', '');
          ta.value = ta.value.substring(0, em.start) + clean + ta.value.substring(pos);
          ta.selectionStart = ta.selectionEnd = cursorIdx >= 0 ? em.start + cursorIdx : em.start + clean.length;
          ta.dispatchEvent(new Event('input'));
          return;
        }
      } catch(ex) {}
    }
  }

  var start = ta.selectionStart, end = ta.selectionEnd;
  ta.value = ta.value.substring(0, start) + '  ' + ta.value.substring(end);
  ta.selectionStart = ta.selectionEnd = start + 2;
  ta.dispatchEvent(new Event('input'));
}

// ---- Auto-close HTML tags on > ----
function handleAutoClose(e) {
  if (e.key !== '>') return;
  var ta = e.target;
  var pos = ta.selectionStart;
  var before = ta.value.substring(0, pos);
  if (/<\/[a-zA-Z][a-zA-Z0-9]*\s*$/.test(before)) return;
  if (before.endsWith('/')) return;
  var m = before.match(/<([a-zA-Z][a-zA-Z0-9]*)(?:\s[^<]*)?$/);
  if (!m) return;
  var tag = m[1].toLowerCase();
  if (voidElements.has(tag)) return;
  e.preventDefault();
  var after = ta.value.substring(pos);
  var closing = '>\x3c/' + tag + '>';
  ta.value = before + closing + after;
  ta.selectionStart = ta.selectionEnd = pos + 1;
  ta.dispatchEvent(new Event('input'));
}

// ---- Smart Enter: auto-indent and expand between tags ----
function handleEnter(e) {
  if (e.key !== 'Enter') return;
  var ta = e.target;
  var pos = ta.selectionStart;
  var before = ta.value.substring(0, pos);
  var after = ta.value.substring(pos);
  var lastLine = before.split('\n').pop();
  var indent = lastLine.match(/^(\s*)/)[1];

  e.preventDefault();

  if (before.endsWith('>') && /^\s*<\//.test(after)) {
    var newText = '\n' + indent + '  \n' + indent;
    ta.value = before + newText + after;
    ta.selectionStart = ta.selectionEnd = pos + indent.length + 3;
  } else {
    var extra = '';
    if (before.match(/<[a-zA-Z][^>]*>\s*$/) && ta === htmlEditor) extra = '  ';
    if (before.match(/\{\s*$/) && ta === cssEditor) extra = '  ';
    ta.value = before + '\n' + indent + extra + after;
    ta.selectionStart = ta.selectionEnd = pos + 1 + indent.length + extra.length;
  }
  ta.dispatchEvent(new Event('input'));
}

// ---- Auto-close CSS braces ----
function handleBrace(e) {
  if (e.key !== '{') return;
  var ta = e.target;
  var pos = ta.selectionStart;
  var after = ta.value.substring(pos);
  if (after[0] === '}') return;
  e.preventDefault();
  var before = ta.value.substring(0, pos);
  ta.value = before + '{}' + after;
  ta.selectionStart = ta.selectionEnd = pos + 1;
  ta.dispatchEvent(new Event('input'));
}

htmlEditor.addEventListener('input', updateHTML);
cssEditor.addEventListener('input', updateCSS);
htmlEditor.addEventListener('keydown', handleTab);
cssEditor.addEventListener('keydown', handleTab);
htmlEditor.addEventListener('keydown', handleAutoClose);
htmlEditor.addEventListener('keydown', handleEnter);
cssEditor.addEventListener('keydown', handleEnter);
cssEditor.addEventListener('keydown', handleBrace);

htmlEditor.addEventListener('scroll', () => syncScroll(htmlEditor, htmlHighlight.parentElement, htmlLines));
cssEditor.addEventListener('scroll', () => syncScroll(cssEditor, cssHighlight.parentElement, cssLines));

// Resizer
const resizer = document.getElementById('resizer');
const editorsPane = document.getElementById('editorsPane');
const previewPane = document.getElementById('previewPane');
let isResizing = false;

resizer.addEventListener('mousedown', (e) => {
  isResizing = true;
  resizer.classList.add('active');
  document.body.style.cursor = 'col-resize';
  document.body.style.userSelect = 'none';
  preview.style.pointerEvents = 'none';
  e.preventDefault();
});

document.addEventListener('mousemove', (e) => {
  if (!isResizing) return;
  const container = document.querySelector('.main');
  const rect = container.getBoundingClientRect();
  const ratio = (e.clientX - rect.left) / rect.width;
  const clamped = Math.max(0.2, Math.min(0.8, ratio));
  editorsPane.style.flex = String(clamped);
  previewPane.style.flex = String(1 - clamped);
});

document.addEventListener('mouseup', () => {
  if (isResizing) {
    isResizing = false;
    resizer.classList.remove('active');
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    preview.style.pointerEvents = '';
  }
});

function resetEditors() {
  htmlEditor.value = defaultHTML;
  cssEditor.value = defaultCSS;
  updateHTML();
  updateCSS();
  markUnsaved();
}

function copyOutput() {
  var h = htmlEditor.value;
  var c = cssEditor.value;
  var full = '<!DOCTYPE html>\n<html>\n<head>\n<style>\n' + c + '\n<\/style>\n<\/head>\n<body>\n' + h + '\n<\/body>\n<\/html>';
  navigator.clipboard.writeText(full).then(function() { showToast('Copied to clipboard!', 'success'); });
}

// ---- Download ZIP ----
function downloadZip() {
  var h = htmlEditor.value;
  var c = cssEditor.value;
  var htmlContent = '<!DOCTYPE html>\n<html>\n<head>\n<link rel="stylesheet" href="style.css">\n<\/head>\n<body>\n' + h + '\n<\/body>\n<\/html>';

  var zip = new JSZip();
  zip.file('index.html', htmlContent);
  zip.file('style.css', c);

  var projects = getProjects();
  var activeId = getActiveId();
  var project = projects.find(function(p) { return p.id === activeId; });
  var filename = (project ? project.name.replace(/[^a-zA-Z0-9_\-]/g, '_') : 'project') + '.zip';

  zip.generateAsync({ type: 'blob' }).then(function(blob) {
    var link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
    URL.revokeObjectURL(link.href);
    showToast('ZIP downloaded!', 'success');
  });
}

// ---- Toast ----
var toastTimer = null;
function showToast(msg, type) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + (type || 'info') + ' show';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function() { t.classList.remove('show'); }, 2000);
}

// ---- Modal helpers ----
var modalCallback = null;
function openModal(title, defaultVal, cb) {
  var overlay = document.getElementById('modalOverlay');
  document.getElementById('modalTitle').textContent = title;
  var inp = document.getElementById('modalInput');
  inp.value = defaultVal || '';
  overlay.classList.add('show');
  inp.focus();
  inp.select();
  modalCallback = cb;
  document.getElementById('modalConfirm').onclick = function() {
    var val = inp.value.trim();
    closeModal();
    if (val && cb) cb(val);
  };
  inp.onkeydown = function(e) {
    if (e.key === 'Enter') { document.getElementById('modalConfirm').click(); }
    if (e.key === 'Escape') { closeModal(); }
  };
}
function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
  modalCallback = null;
}

var confirmCallback = null;
function openConfirm(title, cb) {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmOverlay').classList.add('show');
  confirmCallback = cb;
  document.getElementById('confirmBtn').onclick = function() {
    closeConfirm();
    if (cb) cb();
  };
}
function closeConfirm() {
  document.getElementById('confirmOverlay').classList.remove('show');
  confirmCallback = null;
}

// Close modals on overlay click
document.getElementById('modalOverlay').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
document.getElementById('confirmOverlay').addEventListener('click', function(e) {
  if (e.target === this) closeConfirm();
});

// ---- Project CRUD (localStorage) ----
var STORAGE_KEY = 'liveEditorProjects';
var ACTIVE_KEY = 'liveEditorActiveId';
var unsaved = false;

function getProjects() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
  catch(e) { return []; }
}
function setProjects(arr) { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
function getActiveId() { return localStorage.getItem(ACTIVE_KEY) || ''; }
function setActiveId(id) { localStorage.setItem(ACTIVE_KEY, id || ''); }
function genId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 5); }

function markUnsaved() {
  unsaved = true;
  document.getElementById('unsavedDot').classList.add('show');
}
function markSaved() {
  unsaved = false;
  document.getElementById('unsavedDot').classList.remove('show');
}

function renderProjectList() {
  var list = document.getElementById('sidebarList');
  var projects = getProjects();
  var activeId = getActiveId();
  list.innerHTML = '';
  if (projects.length === 0) {
    list.innerHTML = '\x3cdiv class="sidebar-empty">No projects yet.\x3cbr>Click \x3cb>+ New\x3c/b> to create one.\x3c/div>';
    return;
  }
  projects.forEach(function(p) {
    var card = document.createElement('div');
    card.className = 'project-card' + (p.id === activeId ? ' active' : '');
    card.setAttribute('data-id', p.id);
    var dateStr = p.updatedAt ? new Date(p.updatedAt).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';
    card.innerHTML = '\x3cdiv class="pc-name">' + escapeHTML(p.name) + '\x3c/div>'
      + '\x3cdiv class="pc-date">' + dateStr + '\x3c/div>'
      + '\x3cdiv class="pc-actions">'
      + '\x3cbutton title="Rename" onclick="event.stopPropagation();renameProjectById(\'' + p.id + '\')">&#9998;\x3c/button>'
      + '\x3cbutton class="pc-del" title="Delete" onclick="event.stopPropagation();deleteProjectById(\'' + p.id + '\')">&#10005;\x3c/button>'
      + '\x3c/div>';
    card.addEventListener('click', function() { switchToProject(p.id); });
    list.appendChild(card);
  });
}

// ---- Sidebar toggle ----
document.getElementById('sidebarToggle').addEventListener('click', function() {
  document.getElementById('sidebar').classList.toggle('collapsed');
});

// ---- Switch project (from sidebar click) ----
function switchToProject(id) {
  if (id === getActiveId()) return;
  if (unsaved) {
    openConfirm('You have unsaved changes. Switch anyway?', function() {
      document.getElementById('confirmBtn').textContent = 'Delete';
      loadProject(id);
      renderProjectList();
    });
    document.getElementById('confirmBtn').textContent = 'Switch';
    document.getElementById('confirmBtn').onclick = function() {
      closeConfirm();
      loadProject(id);
      renderProjectList();
    };
    return;
  }
  loadProject(id);
  renderProjectList();
}

// CREATE
function newProject() {
  openModal('New project name:', 'Untitled', function(name) {
    var projects = getProjects();
    var project = {
      id: genId(),
      name: name,
      html: defaultHTML,
      css: defaultCSS,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    projects.push(project);
    setProjects(projects);
    setActiveId(project.id);
    htmlEditor.value = project.html;
    cssEditor.value = project.css;
    updateHTML();
    updateCSS();
    renderProjectList();
    markSaved();
    showToast('Project created!', 'success');
  });
}

// READ
function loadProject(id) {
  var projects = getProjects();
  var project = projects.find(function(p) { return p.id === id; });
  if (!project) return;
  setActiveId(id);
  htmlEditor.value = project.html;
  cssEditor.value = project.css;
  updateHTML();
  updateCSS();
  markSaved();
}

// UPDATE
function saveProject() {
  var activeId = getActiveId();
  var projects = getProjects();
  var project = projects.find(function(p) { return p.id === activeId; });
  if (!project) {
    newProject();
    return;
  }
  project.html = htmlEditor.value;
  project.css = cssEditor.value;
  project.updatedAt = new Date().toISOString();
  setProjects(projects);
  renderProjectList();
  markSaved();
  showToast('Project saved!', 'success');
}

function renameProject() {
  var activeId = getActiveId();
  renameProjectById(activeId);
}

function renameProjectById(id) {
  var projects = getProjects();
  var project = projects.find(function(p) { return p.id === id; });
  if (!project) { showToast('No project selected', 'error'); return; }
  openModal('Rename project:', project.name, function(name) {
    project.name = name;
    project.updatedAt = new Date().toISOString();
    setProjects(projects);
    renderProjectList();
    showToast('Project renamed!', 'success');
  });
}

// DELETE
function deleteProject() {
  var activeId = getActiveId();
  deleteProjectById(activeId);
}

function deleteProjectById(id) {
  var projects = getProjects();
  var project = projects.find(function(p) { return p.id === id; });
  if (!project) { showToast('No project to delete', 'error'); return; }
  openConfirm('Delete "' + project.name + '"? This cannot be undone.', function() {
    projects = projects.filter(function(p) { return p.id !== id; });
    setProjects(projects);
    if (id === getActiveId()) {
      if (projects.length > 0) {
        loadProject(projects[projects.length - 1].id);
      } else {
        setActiveId('');
        htmlEditor.value = defaultHTML;
        cssEditor.value = defaultCSS;
        updateHTML();
        updateCSS();
      }
    }
    renderProjectList();
    markSaved();
    showToast('Project deleted', 'info');
  });
}

// ---- Auto-save draft to localStorage (debounced) ----
var DRAFT_KEY = 'liveEditorDraft';
var autoSaveTimer = null;

function saveDraft() {
  localStorage.setItem(DRAFT_KEY, JSON.stringify({
    html: htmlEditor.value,
    css: cssEditor.value,
    activeId: getActiveId(),
    ts: Date.now()
  }));
}

function loadDraft() {
  try { return JSON.parse(localStorage.getItem(DRAFT_KEY)); }
  catch(e) { return null; }
}

function autoSave() {
  clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(saveDraft, 500);
}

// Track unsaved changes + auto-save draft
htmlEditor.addEventListener('input', function() { markUnsaved(); autoSave(); });
cssEditor.addEventListener('input', function() { markUnsaved(); autoSave(); });

// Ctrl+S to save project
document.addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    saveProject();
  }
});

// ---- Init ----
renderProjectList();
var initId = getActiveId();
var draft = loadDraft();

if (initId) {
  // Load saved project first
  loadProject(initId);
  // If there's a newer draft for this project, restore it
  if (draft && draft.activeId === initId && draft.ts) {
    var projects = getProjects();
    var proj = projects.find(function(p) { return p.id === initId; });
    var projTime = proj && proj.updatedAt ? new Date(proj.updatedAt).getTime() : 0;
    if (draft.ts > projTime) {
      htmlEditor.value = draft.html;
      cssEditor.value = draft.css;
      updateHTML();
      updateCSS();
      if (draft.html !== proj.html || draft.css !== proj.css) markUnsaved();
    }
  }
} else if (draft) {
  // No active project but there's a draft â€” restore it
  htmlEditor.value = draft.html || defaultHTML;
  cssEditor.value = draft.css || defaultCSS;
  updateHTML();
  updateCSS();
} else {
  htmlEditor.value = defaultHTML;
  cssEditor.value = defaultCSS;
  updateHTML();
  updateCSS();
}
</script>
</body>
</html>
