<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live HTML, CSS & JS Editor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #1e1e2e;
    color: #cdd6f4;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  header {
    background: #181825;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #313244;
  }

  header h1 {
    font-size: 16px;
    font-weight: 600;
    color: #cba6f7;
  }

  header .actions {
    display: flex;
    gap: 8px;
  }

  header button {
    background: #313244;
    color: #cdd6f4;
    border: 1px solid #45475a;
    padding: 5px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: background 0.2s;
  }

  header button:hover {
    background: #45475a;
  }

  .main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  .editors {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  .editor-tabs {
    display: flex;
    background: #181825;
    border-bottom: 1px solid #313244;
    flex-shrink: 0;
    overflow-x: auto;
  }

  .editor-tabs::-webkit-scrollbar { height: 3px; }
  .editor-tabs::-webkit-scrollbar-thumb { background: #45475a; border-radius: 4px; }

  .editor-tab {
    padding: 8px 12px;
    padding-right: 28px;
    font-size: 12px;
    font-weight: 600;
    color: #585b70;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    border: none;
    background: none;
    border-bottom: 2px solid transparent;
    transition: color 0.2s, border-color 0.2s, background 0.2s;
    position: relative;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .editor-tab:hover {
    color: #a6adc8;
    background: rgba(203, 166, 247, 0.05);
  }

  .editor-tab.active {
    color: #cdd6f4;
    border-bottom-color: #cba6f7;
    background: #1e1e2e;
  }

  .editor-tab .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .editor-tab .dot.html { background: #fab387; }
  .editor-tab .dot.css { background: #89b4fa; }
  .editor-tab .dot.js { background: #f9e2af; }
  .editor-tab .dot.other { background: #a6adc8; }

  .editor-tab .tab-close {
    position: absolute;
    right: 6px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #585b70;
    cursor: pointer;
    font-size: 14px;
    line-height: 1;
    padding: 0 2px;
    border-radius: 3px;
    transition: color 0.15s, background 0.15s;
  }

  .editor-tab .tab-close:hover {
    color: #f38ba8;
    background: #313244;
  }

  .editor-panel {
    flex: 1;
    display: none;
    flex-direction: column;
    min-height: 0;
  }

  .editor-panel.active {
    display: flex;
  }

  .panel-header {
    background: #181825;
    padding: 6px 14px;
    font-size: 12px;
    font-weight: 600;
    color: #a6adc8;
    display: flex;
    align-items: center;
    gap: 8px;
    border-bottom: 1px solid #313244;
  }

  .panel-header .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .panel-header .dot.html { background: #fab387; }
  .panel-header .dot.css { background: #89b4fa; }
  .panel-header .dot.js { background: #f9e2af; }

  .editor-wrap {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: #1e1e2e;
  }

  .editor-wrap textarea,
  .editor-wrap pre {
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.6;
    padding: 12px 12px 12px 52px;
    white-space: pre;
    overflow: auto;
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    tab-size: 2;
    -moz-tab-size: 2;
  }

  .editor-wrap textarea {
    background: transparent;
    color: transparent;
    caret-color: #f5e0dc;
    border: none;
    outline: none;
    resize: none;
    z-index: 2;
  }

  .editor-wrap pre {
    z-index: 1;
    margin: 0;
    pointer-events: none;
    color: #cdd6f4;
  }

  .editor-wrap pre code {
    font-family: inherit;
    font-size: inherit;
    line-height: inherit;
  }

  .line-numbers {
    position: absolute;
    top: 0;
    left: 0;
    width: 40px;
    height: 100%;
    background: #181825;
    z-index: 3;
    padding: 12px 8px 12px 0;
    text-align: right;
    white-space: pre;
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.6;
    color: #585b70;
    pointer-events: none;
    border-right: 1px solid #313244;
    user-select: none;
  }

  .preview-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    border-left: 2px solid #313244;
    min-width: 0;
  }

  .preview-panel .panel-header .dot { background: #a6e3a1; }

  .preview-panel iframe {
    flex: 1;
    border: none;
    background: #fff;
  }

  .console-panel {
    height: 150px;
    min-height: 150px;
    background: #181825;
    border-top: 1px solid #313244;
    display: flex;
    flex-direction: column;
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', 'Courier New', monospace;
  }

  .console-panel .panel-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 14px;
    font-size: 12px;
    font-weight: 600;
    color: #a6adc8;
    border-bottom: 1px solid #313244;
    background: #181825;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  .console-panel .panel-header button {
    margin-left: auto;
    background: #313244;
    color: #cdd6f4;
    border: 1px solid #45475a;
    padding: 2px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    transition: background 0.2s;
  }

  .console-panel .panel-header button:hover {
    background: #45475a;
  }

  .dot.console { background: #f38ba8; }

  .console-output {
    flex: 1;
    overflow-y: auto;
    padding: 0;
  }

  .console-output::-webkit-scrollbar { width: 4px; }
  .console-output::-webkit-scrollbar-thumb { background: #45475a; border-radius: 4px; }

  .console-entry {
    padding: 4px 12px;
    border-bottom: 1px solid #252536;
    font-size: 12px;
    line-height: 1.5;
    color: #cdd6f4;
    word-break: break-all;
    white-space: pre-wrap;
  }

  .console-entry.warn {
    color: #f9e2af;
    background: rgba(249, 226, 175, 0.05);
  }

  .console-entry.error {
    color: #f38ba8;
    background: rgba(243, 139, 168, 0.05);
  }

  .console-entry.info {
    color: #89b4fa;
  }

  .console-entry .console-timestamp {
    color: #585b70;
    margin-right: 8px;
    font-size: 10px;
  }

  .console-empty {
    color: #585b70;
    font-size: 12px;
    padding: 12px;
    text-align: center;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  .resizer {
    width: 5px;
    cursor: col-resize;
    background: #313244;
    transition: background 0.2s;
    flex-shrink: 0;
  }

  .resizer:hover, .resizer.active {
    background: #cba6f7;
  }

  /* Sidebar */
  .sidebar {
    width: 260px;
    min-width: 260px;
    background: #181825;
    border-right: 1px solid #313244;
    display: flex;
    flex-direction: column;
    transition: margin-left 0.25s ease, opacity 0.25s ease;
    z-index: 10;
    overflow: hidden;
  }

  .sidebar.collapsed {
    margin-left: -260px;
    opacity: 0;
    pointer-events: none;
  }

  .sidebar-section {
    display: flex;
    flex-direction: column;
    border-bottom: 1px solid #313244;
  }

  .sidebar-section.files-section {
    flex: 1;
    border-bottom: none;
    min-height: 0;
  }

  .sidebar-header {
    padding: 12px 14px 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #313244;
    cursor: default;
    flex-shrink: 0;
  }

  .sidebar-header.clickable {
    cursor: pointer;
  }

  .sidebar-header.clickable:hover {
    background: rgba(203, 166, 247, 0.05);
  }

  .sidebar-header h2 {
    font-size: 13px;
    font-weight: 700;
    color: #a6adc8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .sidebar-header button {
    background: #cba6f7;
    color: #1e1e2e;
    border: none;
    padding: 4px 12px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 700;
    transition: background 0.2s;
  }

  .sidebar-header button:hover { background: #b491e0; }

  .sidebar-header .file-actions-bar {
    display: flex;
    gap: 4px;
    margin-left: auto;
  }

  .sidebar-header .file-actions-bar button {
    padding: 4px 8px;
    font-size: 10px;
  }

  .sidebar-list {
    overflow-y: auto;
    padding: 8px;
  }

  .sidebar-list::-webkit-scrollbar { width: 4px; }
  .sidebar-list::-webkit-scrollbar-thumb { background: #45475a; border-radius: 4px; }

  .sidebar-empty {
    text-align: center;
    color: #585b70;
    font-size: 12px;
    padding: 32px 16px;
    line-height: 1.6;
  }

  .project-card {
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 4px;
    border: 1px solid transparent;
    transition: background 0.15s, border-color 0.15s;
    position: relative;
  }

  .project-card:hover {
    background: #1e1e2e;
    border-color: #313244;
  }

  .project-card.active {
    background: #1e1e2e;
    border-color: #cba6f7;
  }

  .project-card .pc-name {
    font-size: 13px;
    font-weight: 600;
    color: #cdd6f4;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding-right: 40px;
  }

  .project-card.active .pc-name { color: #cba6f7; }

  .project-card .pc-date {
    font-size: 10px;
    color: #585b70;
    margin-top: 2px;
  }

  .project-card .pc-actions {
    position: absolute;
    top: 8px;
    right: 8px;
    display: flex;
    gap: 2px;
    opacity: 0;
    transition: opacity 0.15s;
  }

  .project-card:hover .pc-actions { opacity: 1; }
  .project-card.active .pc-actions { opacity: 1; }

  .pc-actions button {
    background: none;
    border: none;
    color: #6c7086;
    cursor: pointer;
    padding: 2px 5px;
    border-radius: 4px;
    font-size: 13px;
    line-height: 1;
    transition: color 0.15s, background 0.15s;
  }

  .pc-actions button:hover { color: #cdd6f4; background: #313244; }
  .pc-actions button.pc-del:hover { color: #f38ba8; background: #313244; }

  .sidebar-toggle {
    background: none;
    border: none;
    color: #a6adc8;
    cursor: pointer;
    font-size: 18px;
    padding: 2px 8px;
    border-radius: 4px;
    transition: color 0.2s, background 0.2s;
    line-height: 1;
  }

  .sidebar-toggle:hover { color: #cba6f7; background: #313244; }

  .header-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .unsaved-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #fab387;
    display: none;
    flex-shrink: 0;
    margin-left: -4px;
  }

  .unsaved-dot.show { display: inline-block; }

  /* File tree */
  .file-tree {
    flex: 1;
    overflow-y: auto;
    padding: 4px 0;
  }

  .file-tree::-webkit-scrollbar { width: 4px; }
  .file-tree::-webkit-scrollbar-thumb { background: #45475a; border-radius: 4px; }

  .file-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    cursor: pointer;
    font-size: 12px;
    color: #cdd6f4;
    border-left: 2px solid transparent;
    transition: background 0.1s, border-color 0.1s;
    position: relative;
  }

  .file-item:hover {
    background: rgba(203, 166, 247, 0.05);
  }

  .file-item.active {
    background: rgba(203, 166, 247, 0.1);
    border-left-color: #cba6f7;
  }

  .file-item .file-actions {
    position: absolute;
    right: 6px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 2px;
    opacity: 0;
    transition: opacity 0.15s;
  }

  .file-item:hover .file-actions { opacity: 1; }

  .file-actions button {
    background: none;
    border: none;
    color: #6c7086;
    cursor: pointer;
    padding: 1px 4px;
    border-radius: 3px;
    font-size: 11px;
    line-height: 1;
    transition: color 0.15s, background 0.15s;
  }

  .file-actions button:hover { color: #cdd6f4; background: #313244; }
  .file-actions button.fa-del:hover { color: #f38ba8; background: #313244; }

  .folder-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    cursor: pointer;
    font-size: 12px;
    color: #a6adc8;
    font-weight: 600;
    transition: background 0.1s;
    position: relative;
  }

  .folder-item:hover {
    background: rgba(203, 166, 247, 0.05);
  }

  .folder-item .folder-arrow {
    font-size: 10px;
    transition: transform 0.15s;
    display: inline-block;
    width: 12px;
    text-align: center;
  }

  .folder-item .file-actions {
    position: absolute;
    right: 6px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 2px;
    opacity: 0;
    transition: opacity 0.15s;
  }

  .folder-item:hover .file-actions { opacity: 1; }

  .folder-children {
    padding-left: 16px;
  }

  .folder-children.collapsed {
    display: none;
  }

  .file-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .file-dot.html { background: #fab387; }
  .file-dot.css { background: #89b4fa; }
  .file-dot.js { background: #f9e2af; }
  .file-dot.other { background: #a6adc8; }

  .editor-empty {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #585b70;
    font-size: 14px;
  }

  /* Toast notification */
  .toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    padding: 10px 24px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s, transform 0.3s;
  }

  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  .toast.success { background: #a6e3a1; color: #1e1e2e; }
  .toast.error { background: #f38ba8; color: #1e1e2e; }
  .toast.info { background: #89b4fa; color: #1e1e2e; }

  /* Confirm dialog */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 900;
    display: none;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.show { display: flex; }

  .modal {
    background: #1e1e2e;
    border: 1px solid #45475a;
    border-radius: 12px;
    padding: 24px;
    min-width: 320px;
    max-width: 420px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  }

  .modal h3 {
    font-size: 15px;
    margin-bottom: 12px;
    color: #cdd6f4;
  }

  .modal input {
    width: 100%;
    padding: 8px 12px;
    background: #313244;
    border: 1px solid #45475a;
    border-radius: 6px;
    color: #cdd6f4;
    font-size: 13px;
    outline: none;
    margin-bottom: 16px;
  }

  .modal input:focus { border-color: #cba6f7; }

  .modal .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }

  .modal button {
    background: #313244;
    color: #cdd6f4;
    border: 1px solid #45475a;
    padding: 6px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
  }

  .modal button:hover { background: #45475a; }

  .modal button.primary {
    background: #cba6f7;
    color: #1e1e2e;
    border-color: #cba6f7;
  }

  .modal button.primary:hover { background: #b491e0; }

  .modal button.danger {
    background: #f38ba8;
    color: #1e1e2e;
    border-color: #f38ba8;
  }

  .modal button.danger:hover { background: #e07090; }

  /* Syntax highlighting colors */
  .hl-tag { color: #f38ba8; }
  .hl-attr { color: #fab387; }
  .hl-str { color: #a6e3a1; }
  .hl-comment { color: #585b70; font-style: italic; }
  .hl-entity { color: #f5c2e7; }
  .hl-bracket { color: #6c7086; }
  .hl-text { color: #cdd6f4; }
  .hl-css-sel { color: #f38ba8; }
  .hl-css-prop { color: #89b4fa; }
  .hl-css-val { color: #a6e3a1; }
  .hl-css-unit { color: #fab387; }
  .hl-css-punct { color: #6c7086; }
  .hl-css-comment { color: #585b70; font-style: italic; }
  .hl-css-atrule { color: #cba6f7; }
  .hl-css-important { color: #f38ba8; font-weight: bold; }
  .hl-js-kw { color: #cba6f7; }
  .hl-js-str { color: #a6e3a1; }
  .hl-js-num { color: #fab387; }
  .hl-js-comment { color: #585b70; font-style: italic; }
  .hl-js-fn { color: #89b4fa; }
  .hl-js-punct { color: #6c7086; }
  .hl-js-regex { color: #f5c2e7; }
  .hl-js-templ { color: #a6e3a1; }
  .hl-js-obj { color: #f9e2af; }
</style>
</head>
<body>

<header>
  <div class="header-left">
    <button class="sidebar-toggle" id="sidebarToggle" title="Toggle projects">&#9776;</button>
    <h1>&#9998; Live HTML, CSS &amp; JS Editor</h1>
    <span class="unsaved-dot" id="unsavedDot" title="Unsaved changes"></span>
  </div>
  <div class="actions">
    <button onclick="saveProject()">Save</button>
    <button onclick="resetEditors()">Reset</button>
    <button onclick="copyOutput()">Copy Output</button>
    <button onclick="downloadZip()">Download ZIP</button>
  </div>
</header>

<div id="toast" class="toast"></div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modal">
    <h3 id="modalTitle"></h3>
    <input type="text" id="modalInput" autocomplete="off">
    <div class="modal-actions">
      <button onclick="closeModal()">Cancel</button>
      <button class="primary" id="modalConfirm">OK</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="confirmOverlay">
  <div class="modal" id="confirmModal">
    <h3 id="confirmTitle"></h3>
    <div class="modal-actions">
      <button onclick="closeConfirm()">Cancel</button>
      <button class="danger" id="confirmBtn">Delete</button>
    </div>
  </div>
</div>

<div class="main">
  <div class="sidebar" id="sidebar">
    <!-- Projects section -->
    <div class="sidebar-section">
      <div class="sidebar-header clickable" onclick="toggleSection('projects')">
        <h2><span id="projectsArrow">&#9662;</span> Projects</h2>
        <button onclick="event.stopPropagation();newProject()">+ New</button>
      </div>
      <div class="sidebar-list" id="sidebarList"></div>
    </div>
    <!-- Files section -->
    <div class="sidebar-section files-section">
      <div class="sidebar-header">
        <h2>Files</h2>
        <div class="file-actions-bar">
          <button onclick="createNewFile()" title="New File">+ File</button>
          <button onclick="createNewFolder()" title="New Folder">+ Folder</button>
        </div>
      </div>
      <div class="file-tree" id="fileTree"></div>
    </div>
  </div>

  <div class="editors" id="editorsPane">
    <div class="editor-tabs" id="editorTabs"></div>
    <div class="editor-panel active" id="editorPanel">
      <div class="editor-wrap">
        <div class="line-numbers" id="editorLines">1</div>
        <pre><code id="editorHighlight"></code></pre>
        <textarea id="editor" spellcheck="false"></textarea>
      </div>
    </div>
    <div class="editor-empty" id="editorEmpty" style="display:none;">Select a file to start editing</div>
  </div>

  <div class="resizer" id="resizer"></div>

  <div class="preview-panel" id="previewPane">
    <div class="panel-header"><span class="dot"></span>Preview</div>
    <iframe id="preview"></iframe>
    <div class="console-panel">
      <div class="panel-header">
        <span class="dot console"></span>Console
        <button onclick="clearConsole()">Clear</button>
      </div>
      <div class="console-output" id="consoleOutput">
        <div class="console-empty">Console output will appear here...</div>
      </div>
    </div>
  </div>
</div>

<script>
var editor = document.getElementById('editor');
var editorHighlight = document.getElementById('editorHighlight');
var editorLines = document.getElementById('editorLines');
var editorPanel = document.getElementById('editorPanel');
var editorEmpty = document.getElementById('editorEmpty');
var editorTabs = document.getElementById('editorTabs');
var preview = document.getElementById('preview');
var consoleOutput = document.getElementById('consoleOutput');

var openFiles = [];       // array of file IDs currently open as tabs
var activeFileId = null;  // currently displayed file ID
var collapsedFolders = {}; // track collapsed folder IDs

var defaultHTML = '<div class="card">\n  <h1>Hello World!<\/h1>\n  <p>Start editing to see changes live.<\/p>\n  <button class="btn">Click Me<\/button>\n<\/div>';

var defaultCSS = 'body {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  min-height: 100vh;\n  margin: 0;\n  background: #f0f0f0;\n  font-family: sans-serif;\n}\n\n.card {\n  background: white;\n  padding: 40px;\n  border-radius: 12px;\n  box-shadow: 0 4px 24px rgba(0,0,0,0.1);\n  text-align: center;\n}\n\nh1 {\n  color: #333;\n  margin-bottom: 10px;\n}\n\np {\n  color: #666;\n  margin-bottom: 20px;\n}\n\n.btn {\n  background: #6c5ce7;\n  color: white;\n  border: none;\n  padding: 10px 28px;\n  border-radius: 6px;\n  font-size: 16px;\n  cursor: pointer;\n  transition: background 0.2s;\n}\n\n.btn:hover {\n  background: #5a4bd1;\n}';

var defaultJS = 'const btn = document.querySelector(\'.btn\');\nlet count = 0;\n\nbtn.addEventListener(\'click\', function() {\n  count++;\n  btn.textContent = \'Clicked \' + count + \' times\';\n});';

function escapeHTML(str) {
  return str.replace(/&/g, '&amp;').replace(/\x3c/g, '&lt;').replace(/>/g, '&gt;');
}

// ---- Language detection from filename ----
function getLang(filename) {
  if (!filename) return 'text';
  var ext = filename.split('.').pop().toLowerCase();
  if (ext === 'html' || ext === 'htm') return 'html';
  if (ext === 'css') return 'css';
  if (ext === 'js') return 'js';
  return 'text';
}

function getLangDotClass(filename) {
  var lang = getLang(filename);
  if (lang === 'text') return 'other';
  return lang;
}

// ---- HTML Syntax Highlighting ----
function highlightHTML(code) {
  let result = '';
  let i = 0;
  while (i < code.length) {
    if (code.startsWith('<!--', i)) {
      let end = code.indexOf('-->', i);
      if (end === -1) end = code.length - 3;
      result += '<span class="hl-comment">' + escapeHTML(code.slice(i, end + 3)) + '</span>';
      i = end + 3;
    }
    else if (code[i] === '<' && (code[i+1] === '/' || /[a-zA-Z!]/.test(code[i+1] || ''))) {
      let tag = '<span class="hl-bracket">&lt;</span>';
      i++;
      if (code[i] === '/') { tag += '<span class="hl-bracket">/</span>'; i++; }
      let name = '';
      while (i < code.length && /[a-zA-Z0-9\-]/.test(code[i])) { name += code[i]; i++; }
      tag += '<span class="hl-tag">' + escapeHTML(name) + '</span>';
      while (i < code.length && code[i] !== '>' && !(code[i] === '/' && code[i+1] === '>')) {
        if (/\s/.test(code[i])) { tag += code[i]; i++; continue; }
        let attr = '';
        while (i < code.length && /[a-zA-Z0-9\-_]/.test(code[i])) { attr += code[i]; i++; }
        if (attr) tag += '<span class="hl-attr">' + escapeHTML(attr) + '</span>';
        if (code[i] === '=') {
          tag += '<span class="hl-bracket">=</span>'; i++;
          if (code[i] === '"' || code[i] === "'") {
            let q = code[i]; let val = q; i++;
            while (i < code.length && code[i] !== q) { val += code[i]; i++; }
            if (i < code.length) { val += code[i]; i++; }
            tag += '<span class="hl-str">' + escapeHTML(val) + '</span>';
          }
        }
        if (!/[\s\/>a-zA-Z0-9\-_=]/.test(code[i] || '>')) { tag += escapeHTML(code[i] || ''); i++; }
      }
      if (code[i] === '/' && code[i+1] === '>') {
        tag += '<span class="hl-bracket">/&gt;</span>'; i += 2;
      } else if (code[i] === '>') {
        tag += '<span class="hl-bracket">&gt;</span>'; i++;
      }
      result += tag;
    }
    else if (code[i] === '&') {
      let ent = '&';
      i++;
      while (i < code.length && /[a-zA-Z0-9#]/.test(code[i])) { ent += code[i]; i++; }
      if (code[i] === ';') { ent += ';'; i++; }
      result += '<span class="hl-entity">' + escapeHTML(ent) + '</span>';
    }
    else {
      result += escapeHTML(code[i]);
      i++;
    }
  }
  return result;
}

// ---- CSS Syntax Highlighting ----
function highlightCSS(code) {
  let result = '';
  let i = 0;
  while (i < code.length) {
    if (code[i] === '/' && code[i+1] === '*') {
      let end = code.indexOf('*/', i + 2);
      if (end === -1) end = code.length - 2;
      result += '<span class="hl-css-comment">' + escapeHTML(code.slice(i, end + 2)) + '</span>';
      i = end + 2;
    }
    else if (code[i] === '@') {
      let word = '@';
      i++;
      while (i < code.length && /[a-zA-Z\-]/.test(code[i])) { word += code[i]; i++; }
      result += '<span class="hl-css-atrule">' + escapeHTML(word) + '</span>';
    }
    else if (code[i] === '{') {
      result += '<span class="hl-css-punct">{</span>';
      i++;
      while (i < code.length && code[i] !== '}') {
        if (code[i] === '/' && code[i+1] === '*') {
          let end = code.indexOf('*/', i + 2);
          if (end === -1) end = code.length - 2;
          result += '<span class="hl-css-comment">' + escapeHTML(code.slice(i, end + 2)) + '</span>';
          i = end + 2;
        }
        else if (code[i] === '{') {
          result += '<span class="hl-css-punct">{</span>';
          i++;
        }
        else if (/\s/.test(code[i])) {
          result += code[i]; i++;
        }
        else {
          let prop = '';
          while (i < code.length && code[i] !== ':' && code[i] !== '}' && code[i] !== '{' && !(code[i] === '/' && code[i+1] === '*')) {
            prop += code[i]; i++;
          }
          if (code[i] === ':') {
            result += '<span class="hl-css-prop">' + escapeHTML(prop) + '</span>';
            result += '<span class="hl-css-punct">:</span>';
            i++;
            let val = '';
            while (i < code.length && code[i] !== ';' && code[i] !== '}') {
              val += code[i]; i++;
            }
            let hv = escapeHTML(val);
            hv = hv.replace(/(\d+\.?\d*)(px|em|rem|%|vh|vw|vmin|vmax|s|ms|deg|fr|ch|ex)/g,
              '$1<span class="hl-css-unit">$2</span>');
            hv = hv.replace(/(!important)/g, '<span class="hl-css-important">$1</span>');
            result += '<span class="hl-css-val">' + hv + '</span>';
            if (code[i] === ';') {
              result += '<span class="hl-css-punct">;</span>'; i++;
            }
          } else {
            result += '<span class="hl-css-sel">' + escapeHTML(prop) + '</span>';
          }
        }
      }
      if (code[i] === '}') {
        result += '<span class="hl-css-punct">}</span>'; i++;
      }
    }
    else if (/\s/.test(code[i])) {
      result += code[i]; i++;
    }
    else {
      let sel = '';
      while (i < code.length && code[i] !== '{' && !(code[i] === '/' && code[i+1] === '*')) {
        sel += code[i]; i++;
      }
      result += '<span class="hl-css-sel">' + escapeHTML(sel) + '</span>';
    }
  }
  return result;
}

// ---- JS Syntax Highlighting ----
function highlightJS(code) {
  var jsKeywords = /^(var|let|const|function|return|if|else|for|while|do|switch|case|break|continue|new|this|typeof|instanceof|in|of|class|extends|super|import|export|default|from|try|catch|finally|throw|async|await|yield|delete|void|null|undefined|true|false|NaN|Infinity)$/;
  var result = '';
  var i = 0;
  while (i < code.length) {
    if (code[i] === '/' && code[i+1] === '/') {
      var end = code.indexOf('\n', i);
      if (end === -1) end = code.length;
      result += '<span class="hl-js-comment">' + escapeHTML(code.slice(i, end)) + '</span>';
      i = end;
    }
    else if (code[i] === '/' && code[i+1] === '*') {
      var end = code.indexOf('*/', i + 2);
      if (end === -1) end = code.length - 2;
      result += '<span class="hl-js-comment">' + escapeHTML(code.slice(i, end + 2)) + '</span>';
      i = end + 2;
    }
    else if (code[i] === '`') {
      var s = '`'; i++;
      while (i < code.length && code[i] !== '`') {
        if (code[i] === '\\') { s += code[i] + (code[i+1] || ''); i += 2; }
        else { s += code[i]; i++; }
      }
      if (i < code.length) { s += '`'; i++; }
      result += '<span class="hl-js-templ">' + escapeHTML(s) + '</span>';
    }
    else if (code[i] === '"' || code[i] === "'") {
      var q = code[i]; var s = q; i++;
      while (i < code.length && code[i] !== q && code[i] !== '\n') {
        if (code[i] === '\\') { s += code[i] + (code[i+1] || ''); i += 2; }
        else { s += code[i]; i++; }
      }
      if (i < code.length && code[i] === q) { s += q; i++; }
      result += '<span class="hl-js-str">' + escapeHTML(s) + '</span>';
    }
    else if (/[0-9]/.test(code[i]) && (i === 0 || !/[a-zA-Z_$]/.test(code[i-1]))) {
      var num = '';
      while (i < code.length && /[0-9a-fA-FxXoObBeE._]/.test(code[i])) { num += code[i]; i++; }
      result += '<span class="hl-js-num">' + escapeHTML(num) + '</span>';
    }
    else if (/[a-zA-Z_$]/.test(code[i])) {
      var word = '';
      while (i < code.length && /[a-zA-Z0-9_$]/.test(code[i])) { word += code[i]; i++; }
      if (jsKeywords.test(word)) {
        result += '<span class="hl-js-kw">' + escapeHTML(word) + '</span>';
      } else if (i < code.length && code[i] === '(') {
        result += '<span class="hl-js-fn">' + escapeHTML(word) + '</span>';
      } else if (i < code.length && code[i] === '.') {
        result += '<span class="hl-js-obj">' + escapeHTML(word) + '</span>';
      } else {
        result += escapeHTML(word);
      }
    }
    else if (/[{}()\[\];:.,=<>!&|?+\-*/%~^]/.test(code[i])) {
      result += '<span class="hl-js-punct">' + escapeHTML(code[i]) + '</span>';
      i++;
    }
    else {
      result += escapeHTML(code[i]);
      i++;
    }
  }
  return result;
}

// ---- Plain text "highlighting" (just escape) ----
function highlightText(code) {
  return escapeHTML(code);
}

function updateLineNumbers(text, el) {
  var count = text.split('\n').length;
  var nums = '';
  for (var i = 1; i <= count; i++) nums += i + '\n';
  el.textContent = nums;
}

function syncScroll(textarea, pre, lineNums) {
  pre.scrollTop = textarea.scrollTop;
  pre.scrollLeft = textarea.scrollLeft;
  lineNums.style.transform = 'translateY(' + (-textarea.scrollTop) + 'px)';
}

// ---- Console Panel ----
window.addConsoleEntry = function(type) {
  var args = Array.prototype.slice.call(arguments, 1);
  var empty = consoleOutput.querySelector('.console-empty');
  if (empty) empty.remove();

  var entry = document.createElement('div');
  entry.className = 'console-entry ' + type;

  var ts = document.createElement('span');
  ts.className = 'console-timestamp';
  var now = new Date();
  ts.textContent = now.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  entry.appendChild(ts);

  var parts = [];
  for (var i = 0; i < args.length; i++) {
    var arg = args[i];
    if (arg === null) { parts.push('null'); }
    else if (arg === undefined) { parts.push('undefined'); }
    else if (typeof arg === 'object') {
      try { parts.push(JSON.stringify(arg, null, 2)); }
      catch(e) { parts.push(String(arg)); }
    } else {
      parts.push(String(arg));
    }
  }
  entry.appendChild(document.createTextNode(parts.join(' ')));
  consoleOutput.appendChild(entry);
  consoleOutput.scrollTop = consoleOutput.scrollHeight;
};

window.clearConsole = function() {
  consoleOutput.innerHTML = '<div class="console-empty">Console output will appear here...</div>';
};

// ---- Data Model Helpers ----
var STORAGE_KEY = 'liveEditorProjects';
var ACTIVE_KEY = 'liveEditorActiveId';
var DRAFT_KEY = 'liveEditorDraft';
var unsaved = false;

function getProjects() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
  catch(e) { return []; }
}
function setProjects(arr) { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
function getActiveId() { return localStorage.getItem(ACTIVE_KEY) || ''; }
function setActiveId(id) { localStorage.setItem(ACTIVE_KEY, id || ''); }
function genId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 5); }

function getCurrentProject() {
  var projects = getProjects();
  var activeId = getActiveId();
  return projects.find(function(p) { return p.id === activeId; }) || null;
}

// ---- Migration: old flat project -> files array ----
function migrateProject(p) {
  if (p.files) return p;
  p.files = [
    { id: genId(), name: 'index.html', type: 'file', parentId: null, content: p.html || defaultHTML },
    { id: genId(), name: 'style.css', type: 'file', parentId: null, content: p.css || defaultCSS },
    { id: genId(), name: 'script.js', type: 'file', parentId: null, content: p.js || defaultJS }
  ];
  delete p.html;
  delete p.css;
  delete p.js;
  return p;
}

function markUnsaved() {
  unsaved = true;
  document.getElementById('unsavedDot').classList.add('show');
}
function markSaved() {
  unsaved = false;
  document.getElementById('unsavedDot').classList.remove('show');
}

// ---- Sync active file content from editor ----
function syncActiveFileContent() {
  if (!activeFileId) return;
  var projects = getProjects();
  var activeId = getActiveId();
  var project = projects.find(function(p) { return p.id === activeId; });
  if (!project || !project.files) return;
  var file = project.files.find(function(f) { return f.id === activeFileId; });
  if (file) {
    file.content = editor.value;
    setProjects(projects);
  }
}

// ---- Editor Display ----
function updateEditorDisplay() {
  if (!activeFileId) return;
  var project = getCurrentProject();
  if (!project || !project.files) return;
  var file = project.files.find(function(f) { return f.id === activeFileId; });
  if (!file) return;
  var lang = getLang(file.name);
  var code = editor.value;
  if (lang === 'html') {
    editorHighlight.innerHTML = highlightHTML(code) + '\n';
  } else if (lang === 'css') {
    editorHighlight.innerHTML = highlightCSS(code) + '\n';
  } else if (lang === 'js') {
    editorHighlight.innerHTML = highlightJS(code) + '\n';
  } else {
    editorHighlight.innerHTML = highlightText(code) + '\n';
  }
  updateLineNumbers(code, editorLines);
}

// ---- Preview ----
function updatePreview() {
  var project = getCurrentProject();
  if (!project || !project.files) return;
  syncActiveFileContent();
  // Re-read project after sync
  project = getCurrentProject();
  var allCSS = '', allHTML = '', allJS = '';
  project.files.forEach(function(f) {
    if (f.type !== 'file') return;
    var lang = getLang(f.name);
    if (lang === 'css') allCSS += f.content + '\n';
    else if (lang === 'html') allHTML += f.content + '\n';
    else if (lang === 'js') allJS += f.content + '\n';
  });
  clearConsole();
  var consoleOverride = '(function(){'
    + 'var _log=console.log,_warn=console.warn,_error=console.error,_info=console.info,_clear=console.clear;'
    + 'function _send(t,a){try{parent.addConsoleEntry.apply(null,[t].concat(Array.prototype.slice.call(a)));}catch(e){}}'
    + 'console.log=function(){_send("log",arguments);_log.apply(console,arguments);};'
    + 'console.warn=function(){_send("warn",arguments);_warn.apply(console,arguments);};'
    + 'console.error=function(){_send("error",arguments);_error.apply(console,arguments);};'
    + 'console.info=function(){_send("info",arguments);_info.apply(console,arguments);};'
    + 'console.clear=function(){try{parent.clearConsole();}catch(e){}_clear.apply(console,arguments);};'
    + 'window.onerror=function(msg,src,line,col,err){'
    + 'var detail=msg;if(line)detail+=" (line "+line;if(col)detail+=":"+col;if(line)detail+=")";'
    + 'try{parent.addConsoleEntry("error",detail);}catch(e){}'
    + '};'
    + '})();';
  var doc = preview.contentDocument || preview.contentWindow.document;
  doc.open();
  doc.write('<!DOCTYPE html><html><head><style>' + allCSS + '<\/style><\/head><body>' + allHTML + '<script>' + consoleOverride + '<\/script><script>' + allJS + '<\/script><\/body><\/html>');
  doc.close();
}

// ---- Tab Management ----
function renderEditorTabs() {
  editorTabs.innerHTML = '';
  var project = getCurrentProject();
  if (!project || !project.files) return;
  openFiles.forEach(function(fid) {
    var file = project.files.find(function(f) { return f.id === fid; });
    if (!file) return;
    var tab = document.createElement('button');
    tab.className = 'editor-tab' + (fid === activeFileId ? ' active' : '');
    tab.setAttribute('data-file-id', fid);
    var dotClass = getLangDotClass(file.name);
    tab.innerHTML = '<span class="dot ' + dotClass + '"></span>' + escapeHTML(file.name)
      + '<span class="tab-close" title="Close tab">&times;</span>';
    tab.addEventListener('click', function(e) {
      if (e.target.classList.contains('tab-close')) return;
      openFile(fid);
    });
    tab.querySelector('.tab-close').addEventListener('click', function(e) {
      e.stopPropagation();
      closeFileTab(fid);
    });
    editorTabs.appendChild(tab);
  });
}

function openFile(fileId) {
  var project = getCurrentProject();
  if (!project || !project.files) return;
  var file = project.files.find(function(f) { return f.id === fileId; });
  if (!file || file.type !== 'file') return;
  // Save current editor content before switching
  syncActiveFileContent();
  // Add to open tabs if not already there
  if (openFiles.indexOf(fileId) === -1) {
    openFiles.push(fileId);
  }
  activeFileId = fileId;
  // Load file content into editor
  editor.value = file.content || '';
  editorPanel.classList.add('active');
  editorEmpty.style.display = 'none';
  updateEditorDisplay();
  renderEditorTabs();
  renderFileTree();
  // Reset scroll
  editor.scrollTop = 0;
  editorHighlight.parentElement.scrollTop = 0;
  editorLines.style.transform = 'translateY(0px)';
}

function closeFileTab(fileId) {
  var idx = openFiles.indexOf(fileId);
  if (idx === -1) return;
  openFiles.splice(idx, 1);
  if (activeFileId === fileId) {
    if (openFiles.length > 0) {
      // Switch to adjacent tab
      var newIdx = Math.min(idx, openFiles.length - 1);
      openFile(openFiles[newIdx]);
    } else {
      activeFileId = null;
      editor.value = '';
      editorHighlight.innerHTML = '';
      editorLines.textContent = '1';
      editorPanel.classList.remove('active');
      editorEmpty.style.display = 'flex';
      renderEditorTabs();
      renderFileTree();
    }
  } else {
    renderEditorTabs();
  }
}

function showEditorEmpty() {
  activeFileId = null;
  editor.value = '';
  editorHighlight.innerHTML = '';
  editorLines.textContent = '1';
  editorPanel.classList.remove('active');
  editorEmpty.style.display = 'flex';
}

// ---- File Tree Rendering ----
function renderFileTree() {
  var tree = document.getElementById('fileTree');
  var project = getCurrentProject();
  if (!project || !project.files) {
    tree.innerHTML = '<div class="sidebar-empty">No project selected.</div>';
    return;
  }
  if (project.files.length === 0) {
    tree.innerHTML = '<div class="sidebar-empty">No files yet.<br>Click <b>+ File</b> to create one.</div>';
    return;
  }
  tree.innerHTML = '';
  renderNodes(tree, null, project.files);
}

function renderNodes(container, parentId, files) {
  // Get items at this level
  var items = files.filter(function(f) { return f.parentId === parentId; });
  // Sort: folders first, then files, alphabetical within each
  var folders = items.filter(function(f) { return f.type === 'folder'; }).sort(function(a, b) { return a.name.localeCompare(b.name); });
  var fileItems = items.filter(function(f) { return f.type === 'file'; }).sort(function(a, b) { return a.name.localeCompare(b.name); });

  folders.forEach(function(folder) {
    var isCollapsed = !!collapsedFolders[folder.id];
    var folderEl = document.createElement('div');

    var row = document.createElement('div');
    row.className = 'folder-item';
    row.innerHTML = '<span class="folder-arrow">' + (isCollapsed ? '&#9656;' : '&#9662;') + '</span>'
      + '<span>' + escapeHTML(folder.name) + '</span>'
      + '<div class="file-actions">'
      + '<button title="New file in folder" onclick="event.stopPropagation();createNewFile(\'' + folder.id + '\')">+</button>'
      + '<button title="Rename" onclick="event.stopPropagation();renameFileById(\'' + folder.id + '\')">&#9998;</button>'
      + '<button class="fa-del" title="Delete" onclick="event.stopPropagation();deleteFileById(\'' + folder.id + '\')">&#10005;</button>'
      + '</div>';
    row.addEventListener('click', function() {
      collapsedFolders[folder.id] = !collapsedFolders[folder.id];
      renderFileTree();
    });
    folderEl.appendChild(row);

    var children = document.createElement('div');
    children.className = 'folder-children' + (isCollapsed ? ' collapsed' : '');
    renderNodes(children, folder.id, files);
    folderEl.appendChild(children);

    container.appendChild(folderEl);
  });

  fileItems.forEach(function(file) {
    var row = document.createElement('div');
    row.className = 'file-item' + (file.id === activeFileId ? ' active' : '');
    var dotClass = getLangDotClass(file.name);
    row.innerHTML = '<span class="file-dot ' + dotClass + '"></span>'
      + '<span>' + escapeHTML(file.name) + '</span>'
      + '<div class="file-actions">'
      + '<button title="Rename" onclick="event.stopPropagation();renameFileById(\'' + file.id + '\')">&#9998;</button>'
      + '<button class="fa-del" title="Delete" onclick="event.stopPropagation();deleteFileById(\'' + file.id + '\')">&#10005;</button>'
      + '</div>';
    row.addEventListener('click', function() {
      openFile(file.id);
    });
    container.appendChild(row);
  });
}

// ---- File/Folder CRUD Operations ----
function createNewFile(parentId) {
  parentId = parentId || null;
  openModal('File name:', 'untitled.html', function(name) {
    var projects = getProjects();
    var activeId = getActiveId();
    var project = projects.find(function(p) { return p.id === activeId; });
    if (!project || !project.files) return;
    // Validate no duplicate in same folder
    var dup = project.files.find(function(f) { return f.parentId === parentId && f.name === name; });
    if (dup) { showToast('A file with that name already exists here.', 'error'); return; }
    var newFile = { id: genId(), name: name, type: 'file', parentId: parentId, content: '' };
    project.files.push(newFile);
    project.updatedAt = new Date().toISOString();
    setProjects(projects);
    renderFileTree();
    openFile(newFile.id);
    markUnsaved();
    showToast('File created!', 'success');
  });
}

function createNewFolder(parentId) {
  parentId = parentId || null;
  openModal('Folder name:', 'new-folder', function(name) {
    var projects = getProjects();
    var activeId = getActiveId();
    var project = projects.find(function(p) { return p.id === activeId; });
    if (!project || !project.files) return;
    var dup = project.files.find(function(f) { return f.parentId === parentId && f.name === name && f.type === 'folder'; });
    if (dup) { showToast('A folder with that name already exists here.', 'error'); return; }
    var newFolder = { id: genId(), name: name, type: 'folder', parentId: parentId };
    project.files.push(newFolder);
    project.updatedAt = new Date().toISOString();
    setProjects(projects);
    renderFileTree();
    showToast('Folder created!', 'success');
  });
}

function renameFileById(fileId) {
  var projects = getProjects();
  var activeId = getActiveId();
  var project = projects.find(function(p) { return p.id === activeId; });
  if (!project || !project.files) return;
  var file = project.files.find(function(f) { return f.id === fileId; });
  if (!file) return;
  openModal('Rename "' + file.name + '":', file.name, function(name) {
    file.name = name;
    project.updatedAt = new Date().toISOString();
    setProjects(projects);
    renderFileTree();
    renderEditorTabs();
    if (activeFileId === fileId) updateEditorDisplay();
    showToast('Renamed!', 'success');
  });
}

function deleteFileById(fileId) {
  var projects = getProjects();
  var activeId = getActiveId();
  var project = projects.find(function(p) { return p.id === activeId; });
  if (!project || !project.files) return;
  var file = project.files.find(function(f) { return f.id === fileId; });
  if (!file) return;
  var label = file.type === 'folder' ? 'folder' : 'file';
  openConfirm('Delete ' + label + ' "' + file.name + '"?' + (file.type === 'folder' ? ' All contents will be deleted.' : ''), function() {
    // Collect all IDs to delete (recursive for folders)
    var idsToDelete = [];
    function collectIds(id) {
      idsToDelete.push(id);
      project.files.forEach(function(f) {
        if (f.parentId === id) collectIds(f.id);
      });
    }
    collectIds(fileId);
    project.files = project.files.filter(function(f) { return idsToDelete.indexOf(f.id) === -1; });
    project.updatedAt = new Date().toISOString();
    setProjects(projects);
    // Close tabs for deleted files
    idsToDelete.forEach(function(did) {
      var idx = openFiles.indexOf(did);
      if (idx !== -1) openFiles.splice(idx, 1);
    });
    if (idsToDelete.indexOf(activeFileId) !== -1) {
      if (openFiles.length > 0) {
        openFile(openFiles[openFiles.length - 1]);
      } else {
        showEditorEmpty();
      }
    }
    renderFileTree();
    renderEditorTabs();
    showToast(label.charAt(0).toUpperCase() + label.slice(1) + ' deleted', 'info');
  });
}

// ---- Void elements (self-closing) ----
var voidElements = new Set(['area','base','br','col','embed','hr','img','input','link','meta','param','source','track','wbr']);

// ---- Emmet Expansion Engine ----
function deepCloneNodes(arr) { return JSON.parse(JSON.stringify(arr)); }

function expandEmmet(abbr) {
  var p = 0;
  function peek() { return p < abbr.length ? abbr[p] : null; }
  function parseIdent() {
    var s = '';
    while (p < abbr.length && /[a-zA-Z0-9]/.test(abbr[p])) s += abbr[p++];
    return s;
  }
  function parseNum() {
    var s = '';
    while (p < abbr.length && /[0-9]/.test(abbr[p])) s += abbr[p++];
    return parseInt(s) || 1;
  }
  function parseText() {
    var s = '', d = 1;
    while (p < abbr.length && d > 0) {
      if (abbr[p] === '{') d++;
      else if (abbr[p] === '}') { d--; if (d === 0) { p++; return s; } }
      s += abbr[p++];
    }
    return s;
  }
  function parseElement() {
    var tag = parseIdent(), id = '', cls = [], txt = '';
    while (p < abbr.length && (abbr[p] === '#' || abbr[p] === '.')) {
      if (abbr[p] === '#') {
        p++; id = '';
        while (p < abbr.length && /[a-zA-Z0-9_-]/.test(abbr[p])) id += abbr[p++];
      } else {
        p++; var c = '';
        while (p < abbr.length && /[a-zA-Z0-9_-]/.test(abbr[p])) c += abbr[p++];
        if (c) cls.push(c);
      }
    }
    if (peek() === '[') {
      p++;
      while (p < abbr.length && abbr[p] !== ']') p++;
      if (peek() === ']') p++;
    }
    if (peek() === '{') { p++; txt = parseText(); }
    if (!tag && !id && cls.length === 0) return null;
    if (!tag) tag = 'div';
    return { tag: tag, id: id, classes: cls, text: txt, children: [] };
  }
  function parseMult() { if (peek() === '*') { p++; return parseNum(); } return 1; }
  function parseFactor() {
    if (peek() === '(') {
      p++;
      var nodes = parseExpr();
      if (peek() === ')') p++;
      var m = parseMult(), res = [];
      for (var i = 0; i < m; i++) res = res.concat(deepCloneNodes(nodes));
      return res;
    }
    var el = parseElement();
    if (!el) return [];
    var m = parseMult();
    if (peek() === '>') { p++; el.children = parseExpr(); }
    var res = [];
    for (var i = 0; i < m; i++) res.push(deepCloneNodes([el])[0]);
    return res;
  }
  function parseExpr() {
    var nodes = parseFactor();
    while (peek() === '+') { p++; nodes = nodes.concat(parseFactor()); }
    return nodes;
  }
  var tree = parseExpr();
  if (tree.length === 0 || p < abbr.length) return null;

  var cursorPlaced = false;
  function renderNode(nd, indent) {
    var sp = '  '.repeat(indent);
    var attrs = '';
    if (nd.id) attrs += ' id="' + nd.id + '"';
    if (nd.classes.length) attrs += ' class="' + nd.classes.join(' ') + '"';
    if (voidElements.has(nd.tag.toLowerCase())) return sp + '\x3c' + nd.tag + attrs + '>';
    var open = '\x3c' + nd.tag + attrs + '>';
    var close = '\x3c/' + nd.tag + '>';
    if (nd.children.length === 0 && !nd.text) {
      if (!cursorPlaced) { cursorPlaced = true; return sp + open + '\0' + close; }
      return sp + open + close;
    }
    if (nd.children.length === 0 && nd.text) return sp + open + nd.text + close;
    var lines = [sp + open];
    if (nd.text) lines.push(sp + '  ' + nd.text);
    for (var j = 0; j < nd.children.length; j++) lines.push(renderNode(nd.children[j], indent + 1));
    lines.push(sp + close);
    return lines.join('\n');
  }
  return tree.map(function(n) { return renderNode(n, 0); }).join('\n');
}

function getEmmetAbbr(text, pos) {
  var start = pos;
  while (start > 0 && /[a-zA-Z0-9#.>+*{}\-_()]/.test(text[start - 1])) start--;
  var abbr = text.substring(start, pos);
  if (!abbr || !/^[a-zA-Z.#(]/.test(abbr)) return null;
  return { start: start, abbr: abbr };
}

// ---- Get active file language ----
function getActiveFileLang() {
  if (!activeFileId) return 'text';
  var project = getCurrentProject();
  if (!project || !project.files) return 'text';
  var file = project.files.find(function(f) { return f.id === activeFileId; });
  if (!file) return 'text';
  return getLang(file.name);
}

// ---- Tab: Emmet expand or indent ----
function handleTab(e) {
  if (e.key !== 'Tab') return;
  e.preventDefault();
  var ta = e.target;
  var pos = ta.selectionStart;
  var lang = getActiveFileLang();

  if (lang === 'html') {
    var em = getEmmetAbbr(ta.value, pos);
    if (em) {
      try {
        var expanded = expandEmmet(em.abbr);
        if (expanded) {
          var lineStart = em.start;
          while (lineStart > 0 && ta.value[lineStart - 1] !== '\n') lineStart--;
          var baseIndent = '';
          var lp = lineStart;
          while (lp < em.start && (ta.value[lp] === ' ' || ta.value[lp] === '\t')) { baseIndent += ta.value[lp]; lp++; }
          var lines = expanded.split('\n');
          var indented = lines[0];
          for (var li = 1; li < lines.length; li++) indented += '\n' + baseIndent + lines[li];
          var cursorIdx = indented.indexOf('\0');
          var clean = indented.replace('\0', '');
          ta.value = ta.value.substring(0, em.start) + clean + ta.value.substring(pos);
          ta.selectionStart = ta.selectionEnd = cursorIdx >= 0 ? em.start + cursorIdx : em.start + clean.length;
          ta.dispatchEvent(new Event('input'));
          return;
        }
      } catch(ex) {}
    }
  }

  var start = ta.selectionStart, end = ta.selectionEnd;
  ta.value = ta.value.substring(0, start) + '  ' + ta.value.substring(end);
  ta.selectionStart = ta.selectionEnd = start + 2;
  ta.dispatchEvent(new Event('input'));
}

// ---- Auto-close HTML tags on > ----
function handleAutoClose(e) {
  if (e.key !== '>') return;
  if (getActiveFileLang() !== 'html') return;
  var ta = e.target;
  var pos = ta.selectionStart;
  var before = ta.value.substring(0, pos);
  if (/<\/[a-zA-Z][a-zA-Z0-9]*\s*$/.test(before)) return;
  if (before.endsWith('/')) return;
  var m = before.match(/<([a-zA-Z][a-zA-Z0-9]*)(?:\s[^<]*)?$/);
  if (!m) return;
  var tag = m[1].toLowerCase();
  if (voidElements.has(tag)) return;
  e.preventDefault();
  var after = ta.value.substring(pos);
  var closing = '>\x3c/' + tag + '>';
  ta.value = before + closing + after;
  ta.selectionStart = ta.selectionEnd = pos + 1;
  ta.dispatchEvent(new Event('input'));
}

// ---- Smart Enter: auto-indent and expand between tags ----
function handleEnter(e) {
  if (e.key !== 'Enter') return;
  var ta = e.target;
  var pos = ta.selectionStart;
  var before = ta.value.substring(0, pos);
  var after = ta.value.substring(pos);
  var lastLine = before.split('\n').pop();
  var indent = lastLine.match(/^(\s*)/)[1];
  var lang = getActiveFileLang();

  e.preventDefault();

  if (before.endsWith('>') && /^\s*<\//.test(after)) {
    var newText = '\n' + indent + '  \n' + indent;
    ta.value = before + newText + after;
    ta.selectionStart = ta.selectionEnd = pos + indent.length + 3;
  } else {
    var extra = '';
    if (before.match(/<[a-zA-Z][^>]*>\s*$/) && lang === 'html') extra = '  ';
    if (before.match(/\{\s*$/) && (lang === 'css' || lang === 'js')) extra = '  ';
    ta.value = before + '\n' + indent + extra + after;
    ta.selectionStart = ta.selectionEnd = pos + 1 + indent.length + extra.length;
  }
  ta.dispatchEvent(new Event('input'));
}

// ---- Auto-close braces ----
function handleBrace(e) {
  if (e.key !== '{') return;
  var lang = getActiveFileLang();
  if (lang !== 'css' && lang !== 'js') return;
  var ta = e.target;
  var pos = ta.selectionStart;
  var after = ta.value.substring(pos);
  if (after[0] === '}') return;
  e.preventDefault();
  var before = ta.value.substring(0, pos);
  ta.value = before + '{}' + after;
  ta.selectionStart = ta.selectionEnd = pos + 1;
  ta.dispatchEvent(new Event('input'));
}

// ---- Editor Event Listeners ----
editor.addEventListener('input', function() {
  updateEditorDisplay();
  updatePreview();
  markUnsaved();
  autoSave();
});

editor.addEventListener('keydown', handleTab);
editor.addEventListener('keydown', handleAutoClose);
editor.addEventListener('keydown', handleEnter);
editor.addEventListener('keydown', handleBrace);

editor.addEventListener('scroll', function() {
  syncScroll(editor, editorHighlight.parentElement, editorLines);
});

// Resizer
var resizer = document.getElementById('resizer');
var editorsPane = document.getElementById('editorsPane');
var previewPane = document.getElementById('previewPane');
var isResizing = false;

resizer.addEventListener('mousedown', function(e) {
  isResizing = true;
  resizer.classList.add('active');
  document.body.style.cursor = 'col-resize';
  document.body.style.userSelect = 'none';
  preview.style.pointerEvents = 'none';
  e.preventDefault();
});

document.addEventListener('mousemove', function(e) {
  if (!isResizing) return;
  var container = document.querySelector('.main');
  var rect = container.getBoundingClientRect();
  var ratio = (e.clientX - rect.left) / rect.width;
  var clamped = Math.max(0.2, Math.min(0.8, ratio));
  editorsPane.style.flex = String(clamped);
  previewPane.style.flex = String(1 - clamped);
});

document.addEventListener('mouseup', function() {
  if (isResizing) {
    isResizing = false;
    resizer.classList.remove('active');
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    preview.style.pointerEvents = '';
  }
});

function resetEditors() {
  var project = getCurrentProject();
  if (!project || !project.files) return;
  project.files.forEach(function(f) {
    if (f.type !== 'file') return;
    var lang = getLang(f.name);
    if (f.name === 'index.html') f.content = defaultHTML;
    else if (f.name === 'style.css') f.content = defaultCSS;
    else if (f.name === 'script.js') f.content = defaultJS;
    else f.content = '';
  });
  var projects = getProjects();
  var activeId = getActiveId();
  var idx = projects.findIndex(function(p) { return p.id === activeId; });
  if (idx !== -1) { projects[idx] = project; setProjects(projects); }
  // Reload current file
  if (activeFileId) {
    var file = project.files.find(function(f) { return f.id === activeFileId; });
    if (file) editor.value = file.content || '';
  }
  updateEditorDisplay();
  updatePreview();
  markUnsaved();
}

function copyOutput() {
  var project = getCurrentProject();
  if (!project || !project.files) return;
  syncActiveFileContent();
  project = getCurrentProject();
  var allCSS = '', allHTML = '', allJS = '';
  project.files.forEach(function(f) {
    if (f.type !== 'file') return;
    var lang = getLang(f.name);
    if (lang === 'css') allCSS += f.content + '\n';
    else if (lang === 'html') allHTML += f.content + '\n';
    else if (lang === 'js') allJS += f.content + '\n';
  });
  var full = '<!DOCTYPE html>\n<html>\n<head>\n<style>\n' + allCSS + '<\/style>\n<\/head>\n<body>\n' + allHTML + '\n<script>\n' + allJS + '<\/script>\n<\/body>\n<\/html>';
  navigator.clipboard.writeText(full).then(function() { showToast('Copied to clipboard!', 'success'); });
}

// ---- Download ZIP ----
function downloadZip() {
  var project = getCurrentProject();
  if (!project || !project.files) return;
  syncActiveFileContent();
  project = getCurrentProject();

  var zip = new JSZip();

  // Build folder structure
  function getFilePath(file) {
    var parts = [file.name];
    var current = file;
    while (current.parentId) {
      var parent = project.files.find(function(f) { return f.id === current.parentId; });
      if (!parent) break;
      parts.unshift(parent.name);
      current = parent;
    }
    return parts.join('/');
  }

  project.files.forEach(function(f) {
    if (f.type === 'file') {
      zip.file(getFilePath(f), f.content || '');
    }
  });

  var filename = (project.name.replace(/[^a-zA-Z0-9_\-]/g, '_') || 'project') + '.zip';

  zip.generateAsync({ type: 'blob' }).then(function(blob) {
    var link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
    URL.revokeObjectURL(link.href);
    showToast('ZIP downloaded!', 'success');
  });
}

// ---- Toast ----
var toastTimer = null;
function showToast(msg, type) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + (type || 'info') + ' show';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function() { t.classList.remove('show'); }, 2000);
}

// ---- Modal helpers ----
var modalCallback = null;
function openModal(title, defaultVal, cb) {
  var overlay = document.getElementById('modalOverlay');
  document.getElementById('modalTitle').textContent = title;
  var inp = document.getElementById('modalInput');
  inp.value = defaultVal || '';
  overlay.classList.add('show');
  inp.focus();
  inp.select();
  modalCallback = cb;
  document.getElementById('modalConfirm').onclick = function() {
    var val = inp.value.trim();
    closeModal();
    if (val && cb) cb(val);
  };
  inp.onkeydown = function(e) {
    if (e.key === 'Enter') { document.getElementById('modalConfirm').click(); }
    if (e.key === 'Escape') { closeModal(); }
  };
}
function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
  modalCallback = null;
}

var confirmCallback = null;
function openConfirm(title, cb) {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmOverlay').classList.add('show');
  confirmCallback = cb;
  document.getElementById('confirmBtn').onclick = function() {
    closeConfirm();
    if (cb) cb();
  };
}
function closeConfirm() {
  document.getElementById('confirmOverlay').classList.remove('show');
  confirmCallback = null;
}

// Close modals on overlay click
document.getElementById('modalOverlay').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
document.getElementById('confirmOverlay').addEventListener('click', function(e) {
  if (e.target === this) closeConfirm();
});

// ---- Sidebar toggle & section toggle ----
document.getElementById('sidebarToggle').addEventListener('click', function() {
  document.getElementById('sidebar').classList.toggle('collapsed');
});

var sectionCollapsed = { projects: false };
function toggleSection(section) {
  sectionCollapsed[section] = !sectionCollapsed[section];
  var list = document.getElementById('sidebarList');
  var arrow = document.getElementById('projectsArrow');
  if (sectionCollapsed[section]) {
    list.style.display = 'none';
    arrow.innerHTML = '&#9656;';
  } else {
    list.style.display = '';
    arrow.innerHTML = '&#9662;';
  }
}

// ---- Project List ----
function renderProjectList() {
  var list = document.getElementById('sidebarList');
  var projects = getProjects();
  var activeId = getActiveId();
  list.innerHTML = '';
  if (projects.length === 0) {
    list.innerHTML = '\x3cdiv class="sidebar-empty">No projects yet.\x3cbr>Click \x3cb>+ New\x3c/b> to create one.\x3c/div>';
    return;
  }
  projects.forEach(function(p) {
    var card = document.createElement('div');
    card.className = 'project-card' + (p.id === activeId ? ' active' : '');
    card.setAttribute('data-id', p.id);
    var dateStr = p.updatedAt ? new Date(p.updatedAt).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';
    card.innerHTML = '\x3cdiv class="pc-name">' + escapeHTML(p.name) + '\x3c/div>'
      + '\x3cdiv class="pc-date">' + dateStr + '\x3c/div>'
      + '\x3cdiv class="pc-actions">'
      + '\x3cbutton title="Rename" onclick="event.stopPropagation();renameProjectById(\'' + p.id + '\')">&#9998;\x3c/button>'
      + '\x3cbutton class="pc-del" title="Delete" onclick="event.stopPropagation();deleteProjectById(\'' + p.id + '\')">&#10005;\x3c/button>'
      + '\x3c/div>';
    card.addEventListener('click', function() { switchToProject(p.id); });
    list.appendChild(card);
  });
}

// ---- Switch project ----
function switchToProject(id) {
  if (id === getActiveId()) return;
  if (unsaved) {
    openConfirm('You have unsaved changes. Switch anyway?', function() {
      document.getElementById('confirmBtn').textContent = 'Delete';
      loadProject(id);
      renderProjectList();
    });
    document.getElementById('confirmBtn').textContent = 'Switch';
    document.getElementById('confirmBtn').onclick = function() {
      closeConfirm();
      loadProject(id);
      renderProjectList();
    };
    return;
  }
  loadProject(id);
  renderProjectList();
}

// ---- CREATE Project ----
function newProject() {
  openModal('New project name:', 'Untitled', function(name) {
    var projects = getProjects();
    var project = {
      id: genId(),
      name: name,
      files: [
        { id: genId(), name: 'index.html', type: 'file', parentId: null, content: defaultHTML },
        { id: genId(), name: 'style.css', type: 'file', parentId: null, content: defaultCSS },
        { id: genId(), name: 'script.js', type: 'file', parentId: null, content: defaultJS }
      ],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    projects.push(project);
    setProjects(projects);
    setActiveId(project.id);
    openFiles = [];
    activeFileId = null;
    // Open index.html by default
    var indexFile = project.files.find(function(f) { return f.name === 'index.html'; });
    if (indexFile) {
      openFile(indexFile.id);
    }
    renderProjectList();
    renderFileTree();
    updatePreview();
    markSaved();
    showToast('Project created!', 'success');
  });
}

// ---- READ / Load Project ----
function loadProject(id) {
  var projects = getProjects();
  var project = projects.find(function(p) { return p.id === id; });
  if (!project) return;
  // Migrate old format
  migrateProject(project);
  setProjects(projects);
  setActiveId(id);
  // Reset tabs
  openFiles = [];
  activeFileId = null;
  // Open first html file or first file
  var firstHtml = project.files.find(function(f) { return f.type === 'file' && getLang(f.name) === 'html'; });
  var firstFile = project.files.find(function(f) { return f.type === 'file'; });
  var toOpen = firstHtml || firstFile;
  if (toOpen) {
    openFile(toOpen.id);
  } else {
    showEditorEmpty();
  }
  renderProjectList();
  renderFileTree();
  updatePreview();
  markSaved();
}

// ---- UPDATE / Save Project ----
function saveProject() {
  var activeId = getActiveId();
  var projects = getProjects();
  var project = projects.find(function(p) { return p.id === activeId; });
  if (!project) {
    newProject();
    return;
  }
  syncActiveFileContent();
  projects = getProjects();
  project = projects.find(function(p) { return p.id === activeId; });
  project.updatedAt = new Date().toISOString();
  setProjects(projects);
  renderProjectList();
  markSaved();
  showToast('Project saved!', 'success');
}

function renameProject() {
  var activeId = getActiveId();
  renameProjectById(activeId);
}

function renameProjectById(id) {
  var projects = getProjects();
  var project = projects.find(function(p) { return p.id === id; });
  if (!project) { showToast('No project selected', 'error'); return; }
  openModal('Rename project:', project.name, function(name) {
    project.name = name;
    project.updatedAt = new Date().toISOString();
    setProjects(projects);
    renderProjectList();
    showToast('Project renamed!', 'success');
  });
}

// ---- DELETE Project ----
function deleteProject() {
  var activeId = getActiveId();
  deleteProjectById(activeId);
}

function deleteProjectById(id) {
  var projects = getProjects();
  var project = projects.find(function(p) { return p.id === id; });
  if (!project) { showToast('No project to delete', 'error'); return; }
  openConfirm('Delete "' + project.name + '"? This cannot be undone.', function() {
    projects = projects.filter(function(p) { return p.id !== id; });
    setProjects(projects);
    if (id === getActiveId()) {
      if (projects.length > 0) {
        loadProject(projects[projects.length - 1].id);
      } else {
        setActiveId('');
        openFiles = [];
        activeFileId = null;
        showEditorEmpty();
        renderFileTree();
        updatePreview();
      }
    }
    renderProjectList();
    markSaved();
    showToast('Project deleted', 'info');
  });
}

// ---- Auto-save draft to localStorage (debounced) ----
var autoSaveTimer = null;

function saveDraft() {
  syncActiveFileContent();
  var project = getCurrentProject();
  localStorage.setItem(DRAFT_KEY, JSON.stringify({
    files: project ? project.files : [],
    activeId: getActiveId(),
    activeFileId: activeFileId,
    openFiles: openFiles,
    ts: Date.now()
  }));
}

function loadDraft() {
  try { return JSON.parse(localStorage.getItem(DRAFT_KEY)); }
  catch(e) { return null; }
}

function autoSave() {
  clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(saveDraft, 500);
}

// Ctrl+S to save project
document.addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    saveProject();
  }
});

// ---- Init ----
renderProjectList();
var initId = getActiveId();
var draft = loadDraft();

if (initId) {
  var projects = getProjects();
  var proj = projects.find(function(p) { return p.id === initId; });
  if (proj) {
    // Migrate if needed
    migrateProject(proj);
    setProjects(projects);
  }
  loadProject(initId);
  // If there's a newer draft for this project, restore it
  if (draft && draft.activeId === initId && draft.ts && draft.files) {
    var projects2 = getProjects();
    var proj2 = projects2.find(function(p) { return p.id === initId; });
    var projTime = proj2 && proj2.updatedAt ? new Date(proj2.updatedAt).getTime() : 0;
    if (draft.ts > projTime) {
      proj2.files = draft.files;
      setProjects(projects2);
      // Restore open tabs
      openFiles = draft.openFiles || [];
      activeFileId = draft.activeFileId || null;
      if (activeFileId) {
        var af = proj2.files.find(function(f) { return f.id === activeFileId; });
        if (af) {
          editor.value = af.content || '';
          editorPanel.classList.add('active');
          editorEmpty.style.display = 'none';
          updateEditorDisplay();
        }
      }
      renderEditorTabs();
      renderFileTree();
      updatePreview();
      markUnsaved();
    }
  }
} else if (draft && draft.files && draft.files.length > 0 && draft.activeId) {
  // Try to load the project from draft
  var projects3 = getProjects();
  var proj3 = projects3.find(function(p) { return p.id === draft.activeId; });
  if (proj3) {
    loadProject(draft.activeId);
  } else {
    showEditorEmpty();
    renderFileTree();
  }
} else {
  // No project, no draft  show empty state
  showEditorEmpty();
  renderFileTree();
}
</script>
</body>
</html>
